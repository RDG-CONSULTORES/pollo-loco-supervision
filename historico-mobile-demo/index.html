<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>An√°lisis Hist√≥rico v2.0 - El Pollo Loco</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reset & Variables */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #FF6B35;
            --secondary: #D63031;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --dark: #2d3436;
            --light: #dfe6e9;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .header .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .last-update {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }
        
        /* Tab Navigation */
        .tab-container {
            background: white;
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--shadow);
            position: sticky;
            top: 60px;
            z-index: 90;
        }
        
        .tab-container::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            user-select: none;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #fff5f2;
        }
        
        .tab i {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .tab span {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Content Area */
        .content {
            padding: 1rem;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        /* Alert Cards */
        .alert-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            cursor: pointer;
        }
        
        .alert-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .alert-icon.critical { background: var(--danger); }
        .alert-icon.warning { background: var(--warning); color: var(--dark); }
        .alert-icon.success { background: var(--success); }
        
        .alert-content h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .alert-content p {
            font-size: 0.875rem;
            color: #636e72;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 1rem 0;
        }
        
        /* Group Selector */
        .group-selector {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .group-selector h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--dark);
        }
        
        .group-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .group-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }
        
        .group-checkbox:active {
            transform: scale(0.95);
        }
        
        .group-checkbox input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 18px;
            height: 18px;
        }
        
        .group-checkbox.selected {
            background: var(--primary);
            color: white;
        }
        
        /* Heat Map Grid */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .heatmap-item {
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .heatmap-item:active {
            transform: scale(0.95);
        }
        
        .heatmap-excellent { background: linear-gradient(135deg, #00b894, #00cec9); }
        .heatmap-good { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .heatmap-warning { background: linear-gradient(135deg, #fdcb6e, #f39c12); }
        .heatmap-critical { background: linear-gradient(135deg, #d63031, #e84393); }
        
        .heatmap-item .group-name {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .heatmap-item .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #636e72;
        }
        
        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            color: var(--primary);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Pull to Refresh */
        .pull-to-refresh {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .pull-to-refresh.active {
            opacity: 1;
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        
        .mb-1 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 2rem; }
        
        /* Swipe Indicator */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .swipe-indicator.show {
            opacity: 1;
        }
        
        /* Heat Map Table */
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .heatmap-table th {
            background: #f8f9fa;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #dfe6e9;
        }
        
        .heatmap-table th:first-child {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 11;
            text-align: left;
            min-width: 80px;
        }
        
        /* EPL CAS Average Row */
        .epl-row {
            position: sticky;
            top: 38px;
            z-index: 9;
            background: linear-gradient(135deg, #FF6B35, #FFA502);
            color: white;
            font-weight: bold;
        }
        
        .epl-row td {
            background: inherit;
            color: white;
            border-bottom: 2px solid #FF6B35;
            font-weight: bold;
            padding: 0.75rem 0.5rem;
        }
        
        .epl-row td:first-child {
            background: linear-gradient(135deg, #FF6B35, #FFA502);
            border-right: 2px solid #FF6B35;
        }
        
        .vs-epl {
            font-size: 0.5rem;
            display: block;
            margin-top: 1px;
            opacity: 0.8;
        }
        
        .vs-epl.above {
            color: #00b894;
        }
        
        .vs-epl.below {
            color: #d63031;
        }
        
        .heatmap-table td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #f1f3f4;
            position: relative;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .heatmap-table td:first-child {
            position: sticky;
            left: 0;
            background: white;
            font-weight: 600;
            font-size: 0.75rem;
            text-align: left;
            border-right: 1px solid #f1f3f4;
            z-index: 9;
        }
        
        .heatmap-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .heatmap-table tbody tr:active {
            background: #e9ecef;
        }
        
        /* Cell colors */
        .heat-excelente { 
            background: linear-gradient(135deg, #00b894, #55efc4); 
            color: white;
        }
        
        .heat-muy-bueno { 
            background: linear-gradient(135deg, #00cec9, #74b9ff); 
            color: white;
        }
        
        .heat-bueno { 
            background: linear-gradient(135deg, #74b9ff, #a29bfe); 
            color: white;
        }
        
        .heat-regular { 
            background: linear-gradient(135deg, #fdcb6e, #f39c12); 
            color: white;
        }
        
        .heat-critico { 
            background: linear-gradient(135deg, #d63031, #e17055); 
            color: white;
        }
        
        .heat-none {
            background: #f1f3f4;
            color: #636e72;
        }
        
        .trend-indicator {
            font-size: 0.625rem;
            position: absolute;
            top: 2px;
            right: 2px;
        }
        
        .diff-value {
            font-size: 0.625rem;
            display: block;
            margin-top: 2px;
            font-weight: normal;
        }
        
        .diff-positive {
            color: white;
        }
        
        .diff-negative {
            color: white;
        }
        
        
        /* Filter Card */
        .filter-card {
            padding: 0.75rem;
        }
        
        .filter-row {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
        }
        
        .filter-row::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .filter-btn i {
            font-size: 1rem;
        }
        
        .filter-btn:active {
            transform: scale(0.95);
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .view-options {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #f1f3f4;
        }
        
        .toggle-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .toggle-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* Expandable Group Cards */
        .group-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .group-card-header {
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .group-card-header:hover {
            background: #f8f9fa;
        }
        
        .group-card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .group-card-metrics {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.75rem;
        }
        
        .group-card-content {
            padding: 0.75rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        
        .group-card.expanded .group-card-content {
            display: block;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 0.875rem;
            color: #636e72;
        }
        
        .group-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.8rem;
        }
        
        .metric-label {
            color: #636e72;
        }
        
        .metric-value {
            font-weight: 600;
        }
        
        .sucursales-list {
            margin-top: 0.75rem;
        }
        
        .periodo-section {
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .periodo-section:last-child {
            border-bottom: none;
        }
        
        .periodo-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .sucursal-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.75rem;
        }
        
        .trend-indicator {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .trend-mejorando {
            background: #d1f2eb;
            color: #00b894;
        }
        
        .trend-estable {
            background: #e3f2fd;
            color: #74b9ff;
        }
        
        .trend-declinando {
            background: #ffeaa7;
            color: #d63031;
        }
        
        /* Selector Options Styles */
        .selector-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
        }
        
        .selector-option-btn {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            background: white;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .selector-option-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* OPTION M: TikTok Style */
        .selector-tiktok {
            position: relative;
            height: 120px;
            width: 200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .tiktok-card {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #FF6B35, #D63031);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform: translateY(0);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .tiktok-arrows {
            position: absolute;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .tiktok-arrow {
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .tiktok-arrow:hover {
            background: rgba(255,255,255,0.4);
        }
        
        /* OPTION K: Mini Cards */
        .selector-cards {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            scrollbar-width: none;
        }
        
        .selector-cards::-webkit-scrollbar {
            display: none;
        }
        
        .mini-card {
            min-width: 80px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid #e9ecef;
            background: white;
            position: relative;
        }
        
        .mini-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .mini-card-name {
            font-size: 0.6rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.1;
        }
        
        .mini-card-check {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transform: scale(0);
            transition: var(--transition);
        }
        
        .mini-card.selected .mini-card-check {
            transform: scale(1);
        }
        
        /* OPTION E: Horizontal Slider */
        .selector-slider {
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
            background: #f8f9fa;
            padding: 0.5rem 0;
        }
        
        .slider-track {
            display: flex;
            gap: 0.5rem;
            padding: 0 0.5rem;
            transition: transform 0.3s ease;
        }
        
        .slider-item {
            min-width: 120px;
            padding: 0.75rem;
            border-radius: 8px;
            background: white;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .slider-item.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .slider-controls {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .slider-controls:hover {
            background: white;
            box-shadow: var(--shadow);
        }
        
        .slider-prev {
            left: 5px;
        }
        
        .slider-next {
            right: 5px;
        }
        
        .selector-info {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #636e72;
        }
        
        /* Mobile-Optimized Slider Styles */
        .slider-container-mobile {
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 0.5rem 0;
        }
        
        .slider-container-mobile::-webkit-scrollbar {
            display: none;
        }
        
        .slider-controls-mobile {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .slider-btn-mobile {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--primary);
            border-radius: 25px;
            background: white;
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 48px;  /* Touch-friendly size */
            min-width: 48px;
        }
        
        .slider-btn-mobile:hover,
        .slider-btn-mobile:active {
            background: var(--primary);
            color: white;
            transform: scale(0.98);
        }
        
        /* Enhanced slider items for touch */
        .slider-track .slider-item {
            min-width: 140px;
            min-height: 60px;
            padding: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            touch-action: manipulation;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-item:active {
            transform: scale(0.95);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.125rem; }
            .tab span { font-size: 0.7rem; }
            .chart-container { height: 250px; }
            .group-grid { grid-template-columns: 1fr; }
            
            /* Enhanced mobile heat map table */
            .heatmap-table {
                font-size: 0.75rem;
            }
            
            .heatmap-table th,
            .heatmap-table td {
                padding: 0.75rem 0.5rem;  /* Increased touch area */
                min-height: 48px;  /* Touch-friendly height */
            }
            
            .heatmap-table td:first-child,
            .heatmap-table th:first-child {
                min-width: 100px;  /* More space for group names */
                font-size: 0.8rem;
                position: sticky;
                left: 0;
                background: white;
                z-index: 10;
                font-weight: 600;
            }
            
            /* Enhanced touch-friendly buttons */
            .filter-btn {
                min-height: 48px;
                min-width: 48px;
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            .slider-btn-mobile {
                min-height: 52px;  /* Extra large for mobile */
                padding: 1rem 1.5rem;
            }
            
            .slider-item {
                min-height: 70px;  /* Larger touch area */
                min-width: 160px;
                font-size: 0.9rem;
            }
            
            .group-card-metrics {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.25rem;
            }
            
            .group-card-header {
                padding: 1rem;  /* More padding for touch */
                min-height: 60px;
            }
            
            .group-card-content {
                padding: 1rem;
            }
            
            /* Better scroll behavior on mobile */
            .slider-container-mobile {
                scroll-behavior: smooth;
                scroll-snap-type: x mandatory;
            }
            
            .slider-item {
                scroll-snap-align: start;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üìä An√°lisis Hist√≥rico</h1>
        <div class="subtitle">El Pollo Loco - Supervisi√≥n Operativa</div>
        <div class="last-update">
            <i class="fas fa-sync-alt"></i>
            √öltima actualizaci√≥n: <span id="lastUpdate">--</span>
        </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tab-container" id="tabContainer">
        <div class="tab active" data-tab="heatmap">
            <i class="fas fa-th"></i>
            <span>Mapa</span>
        </div>
        <div class="tab" data-tab="smart">
            <i class="fas fa-brain"></i>
            <span>Inteligente</span>
        </div>
        <div class="tab" data-tab="trends">
            <i class="fas fa-chart-line"></i>
            <span>Tendencias</span>
        </div>
        <div class="tab" data-tab="alerts">
            <i class="fas fa-bell"></i>
            <span>Alertas</span>
        </div>
    </div>
    
    <!-- Content Area -->
    <div class="content">
        <!-- Tab 4: Alerts & Insights -->
        <div class="tab-content" id="alerts">
            <h2 class="mb-1">üéØ Alertas & Insights</h2>
            
            <!-- Critical Alerts -->
            <div class="card alert-card">
                <div class="alert-icon critical">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h3>3 Grupos Cr√≠ticos</h3>
                    <p>SALTILLO (63.97%), NUEVO LAREDO (74.56%) requieren atenci√≥n inmediata</p>
                </div>
            </div>
            
            <!-- Warning Alerts -->
            <div class="card alert-card">
                <div class="alert-icon warning">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="alert-content">
                    <h3>5 Grupos en Riesgo</h3>
                    <p>Performance por debajo del 85% - tendencia negativa</p>
                </div>
            </div>
            
            <!-- Success Alert -->
            <div class="card alert-card">
                <div class="alert-icon success">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="alert-content">
                    <h3>Top Performers</h3>
                    <p>OGAS (99.72%), TEC (94.66%) liderando la red</p>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card">
                <h3 class="mb-1">üìä Resumen Ejecutivo</h3>
                <div class="chart-container">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tab 2: Smart Analysis -->
        <div class="tab-content" id="smart">
            <h2 class="mb-1">üß† An√°lisis Inteligente</h2>
            
            <!-- Group Selector Options -->
            <div class="card" style="padding: 0.75rem; margin-bottom: 0.75rem;">
                <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Selecciona hasta 5 grupos:</h3>
                
                <!-- Selector Style Options - Removed for cleaner mobile UI -->
                
                <!-- Mobile-Optimized Horizontal Slider (Principal) -->
                <div id="selector-slider" class="selector-slider">
                    <div class="slider-container-mobile">
                        <div class="slider-track" id="sliderTrack">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="slider-controls-mobile">
                        <button class="slider-btn-mobile" onclick="app.selectTop5()">üìä Top 5</button>
                        <button class="slider-btn-mobile" onclick="app.clearGroupSelection()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>
                
                <div class="selector-info">
                    <span id="selectorInfo">Seleccionados: 3/5 grupos</span>
                </div>
            </div>
            
            <!-- Comparison Chart -->
            <div class="card">
                <h3 class="mb-1">üìä Comparaci√≥n vs EPL CAS</h3>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
            
            <!-- Expandable Group Cards -->
            <div id="groupCards">
                <!-- Will be populated dynamically -->
            </div>
            
            <!-- Insights -->
            <div class="card">
                <h3 class="mb-1">üí° Insights Autom√°ticos</h3>
                <div id="smartInsights">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Tab 1: Heat Map -->
        <div class="tab-content active" id="heatmap">
            <h2 class="mb-1">üó∫Ô∏è Mapa de Calor - Evoluci√≥n</h2>
            
            <!-- Color Legend -->
            <div class="card" style="padding: 0.5rem; margin-bottom: 0.75rem;">
                <div style="display: flex; gap: 0.5rem; overflow-x: auto; font-size: 0.7rem;">
                    <div style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap;">
                        <div class="heat-excelente" style="width: 12px; height: 12px; border-radius: 2px;"></div>
                        <span>95-100% Excelente</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap;">
                        <div class="heat-muy-bueno" style="width: 12px; height: 12px; border-radius: 2px;"></div>
                        <span>91-94.9% Muy Bueno</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap;">
                        <div class="heat-bueno" style="width: 12px; height: 12px; border-radius: 2px;"></div>
                        <span>87-90.9% Bueno</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap;">
                        <div class="heat-regular" style="width: 12px; height: 12px; border-radius: 2px;"></div>
                        <span>82-86.9% Regular</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap;">
                        <div class="heat-critico" style="width: 12px; height: 12px; border-radius: 2px;"></div>
                        <span>0-81.9% Cr√≠tico</span>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card filter-card">
                <div class="filter-row">
                    <button class="filter-btn active" data-filter="all">
                        <i class="fas fa-th"></i>
                        <span>Todos</span>
                    </button>
                    <button class="filter-btn" data-filter="critical">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Cr√≠ticos</span>
                    </button>
                    <button class="filter-btn" data-filter="improving">
                        <i class="fas fa-arrow-up"></i>
                        <span>Mejorando</span>
                    </button>
                    <button class="filter-btn" data-filter="declining">
                        <i class="fas fa-arrow-down"></i>
                        <span>Bajando</span>
                    </button>
                </div>
                
                <div class="view-options">
                    <label class="toggle-option">
                        <input type="checkbox" id="showDifferences" checked>
                        <span>Mostrar diferencias</span>
                    </label>
                </div>
            </div>
            
            <!-- Heat Map Table -->
            <div class="card" style="padding: 0; overflow-x: auto;">
                <table class="heatmap-table" id="heatmapTable">
                    <thead>
                        <tr>
                            <th>Grupo</th>
                            <th>NL-T1</th>
                            <th>FOR-S1</th>
                            <th>NL-T2</th>
                            <th>FOR-S2</th>
                            <th>NL-T3</th>
                            <th>Prom</th>
                        </tr>
                    </thead>
                    <tbody id="heatmapBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <!-- Legend -->
            <div class="card">
                <h3 class="mb-1">Leyenda</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #00b894; border-radius: 4px;"></div>
                        <span>‚â•95% Excelente</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #74b9ff; border-radius: 4px;"></div>
                        <span>85-94% Bueno</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #fdcb6e; border-radius: 4px;"></div>
                        <span>75-84% Regular</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; background: #d63031; border-radius: 4px;"></div>
                        <span><75% Cr√≠tico</span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dfe6e9;">
                    <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">üìä Indicadores de Cambio</h4>
                    <div style="font-size: 0.75rem; color: #636e72;">
                        <span style="color: #00b894;">‚ÜóÔ∏è Mejora</span> ‚Ä¢ 
                        <span style="color: #d63031;">‚ÜòÔ∏è Ca√≠da</span> ‚Ä¢ 
                        <span>‚Äî Sin datos</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 4: Trends -->
        <div class="tab-content" id="trends">
            <h2 class="mb-1">üìà Evoluci√≥n & Tendencias</h2>
            
            <!-- Evolution Chart -->
            <div class="card">
                <h3 class="mb-1">Evoluci√≥n Temporal</h3>
                <div class="chart-container">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            
            <!-- Trend Analysis -->
            <div class="card">
                <h3 class="mb-1">üîÆ An√°lisis de Tendencias</h3>
                <div id="trendAnalysis">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <i class="fas fa-sync-alt"></i>
    </div>
    
    <!-- Swipe Indicator -->
    <div class="swipe-indicator" id="swipeIndicator">
        üëÜ Desliza para cambiar de pesta√±a
    </div>
    
    <script>
        // Initialize app
        const app = {
            currentTab: 0,
            tabs: ['heatmap', 'smart', 'trends', 'alerts'],
            charts: {},
            selectedGroups: new Set(['OGAS', 'TEPEYAC', 'RAP']),
            selectorStyle: 'tiktok',
            tiktokIndex: 0,
            sliderOffset: 0,
            groupsList: [],
            touchStartX: 0,
            touchStartY: 0,
            pullStartY: 0,
            isPulling: false,
            
            // Enhanced data structure with detailed branch information
            data: {
                grupos: {
                    'OGAS': [97, null, 98.17, null, 99.72],
                    'TEPEYAC': [91.18, null, 93.17, null, 90.47],
                    'RAP': [null, 89.26, null, 90.46, null],
                    'CRR': [null, 80.26, null, 87.01, null],
                    'EXPO': [88.95, 75.02, 89.29, null, 94.97],
                    'EPL SO': [95.29, null, 93.77, null, null],
                    'TEC': [93.34, null, 93.47, null, 94.66],
                    'EFM': [85.48, null, 92.13, null, 87.19],
                    'PLOG QUER√âTARO': [null, 96.97, null, null, null],
                    'GRUPO MATAMOROS': [null, 90.57, null, 90.84, null],
                    'PLOG LAGUNA': [null, 89.78, null, null, null],
                    'GRUPO RIO BRAVO': [null, 88.3, null, 92.58, null],
                    'GRUPO PIEDRAS NEGRAS': [null, 85.86, null, 94.9, null],
                    'PLOG NUEVO LEON': [92.8, null, 83.03, null, 89.15],
                    'GRUPO CANTERA ROSA': [null, 87.8, null, null, null],
                    'OCHTER TAMPICO': [null, 87.2, null, null, null],
                    'GRUPO SABINAS HIDALGO': [82.58, null, 88.24, null, null],
                    'GRUPO CENTRITO': [null, null, 85.82, null, 83.18],
                    'GRUPO NUEVO LAREDO': [null, 74.56, null, null, null],
                    'GRUPO SALTILLO': [null, null, 71.24, 63.97, null]
                },
                periodos: ['NL-T1', 'FOR-S1', 'NL-T2', 'FOR-S2', 'NL-T3'],
                
                // Detailed group information for expandable cards
                gruposDetallados: {
                    'OGAS': {
                        promedio_general: 98.3,
                        total_sucursales: 8,
                        vs_epl_cas: +8.2,
                        tendencia: 'mejorando',
                        volatilidad: 'baja',
                        periodos: {
                            'NL-T1': {
                                promedio: 97.0,
                                sucursales: [
                                    {nombre: 'Suc OGAS Centro', calificacion: 97.5},
                                    {nombre: 'Suc OGAS Norte', calificacion: 96.5}
                                ]
                            },
                            'NL-T2': {
                                promedio: 98.17,
                                sucursales: [
                                    {nombre: 'Suc OGAS Centro', calificacion: 98.8},
                                    {nombre: 'Suc OGAS Norte', calificacion: 97.6},
                                    {nombre: 'Suc OGAS Sur', calificacion: 98.2}
                                ]
                            },
                            'NL-T3': {
                                promedio: 99.72,
                                sucursales: [
                                    {nombre: 'Suc OGAS Centro', calificacion: 99.9},
                                    {nombre: 'Suc OGAS Norte', calificacion: 99.5}
                                ]
                            }
                        }
                    },
                    'TEPEYAC': {
                        promedio_general: 91.6,
                        total_sucursales: 4,
                        vs_epl_cas: +1.8,
                        tendencia: 'estable',
                        volatilidad: 'media',
                        periodos: {
                            'NL-T1': {
                                promedio: 91.18,
                                sucursales: [
                                    {nombre: 'Tepeyac Plaza', calificacion: 92.1},
                                    {nombre: 'Tepeyac Centro', calificacion: 90.3}
                                ]
                            },
                            'NL-T2': {
                                promedio: 93.17,
                                sucursales: [
                                    {nombre: 'Tepeyac Plaza', calificacion: 93.8},
                                    {nombre: 'Tepeyac Centro', calificacion: 92.5}
                                ]
                            },
                            'NL-T3': {
                                promedio: 90.47,
                                sucursales: [
                                    {nombre: 'Tepeyac Plaza', calificacion: 91.2},
                                    {nombre: 'Tepeyac Centro', calificacion: 89.8}
                                ]
                            }
                        }
                    },
                    'RAP': {
                        promedio_general: 89.9,
                        total_sucursales: 6,
                        vs_epl_cas: +0.1,
                        tendencia: 'mejorando',
                        volatilidad: 'baja',
                        periodos: {
                            'FOR-S1': {
                                promedio: 89.26,
                                sucursales: [
                                    {nombre: 'RAP Guadalajara', calificacion: 90.1},
                                    {nombre: 'RAP Zapopan', calificacion: 88.4}
                                ]
                            },
                            'FOR-S2': {
                                promedio: 90.46,
                                sucursales: [
                                    {nombre: 'RAP Guadalajara', calificacion: 91.2},
                                    {nombre: 'RAP Zapopan', calificacion: 89.7}
                                ]
                            }
                        }
                    },
                    'GRUPO SALTILLO': {
                        promedio_general: 67.6,
                        total_sucursales: 5,
                        vs_epl_cas: -20.4,
                        tendencia: 'declinando',
                        volatilidad: 'alta',
                        periodos: {
                            'NL-T2': {
                                promedio: 71.24,
                                sucursales: [
                                    {nombre: 'Saltillo Centro', calificacion: 74.5},
                                    {nombre: 'Saltillo Norte', calificacion: 68.0}
                                ]
                            },
                            'FOR-S2': {
                                promedio: 63.97,
                                sucursales: [
                                    {nombre: 'Harold R. Pape', calificacion: 63.97}
                                ]
                            }
                        }
                    }
                }
            }
        };
        
        // =====================================================
        // SELECTOR FUNCTIONS
        // =====================================================
        
        app.changeSelectorStyle = function(style) {
            // Update active button
            document.querySelectorAll('.selector-option-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all selectors
            document.getElementById('selector-tiktok').style.display = 'none';
            document.getElementById('selector-cards').style.display = 'none';
            document.getElementById('selector-slider').style.display = 'none';
            document.getElementById('selector-original').style.display = 'none';
            
            // Show selected selector
            document.getElementById('selector-' + style).style.display = 'block';
            this.selectorStyle = style;
            
            // Initialize the selector
            this.initSelector(style);
        };
        
        app.initSelector = function(style) {
            switch(style) {
                case 'tiktok':
                    this.initTikTokSelector();
                    break;
                case 'cards':
                    this.initCardsSelector();
                    break;
                case 'slider':
                    this.initSliderSelector();
                    break;
                case 'original':
                    this.initOriginalSelector();
                    break;
            }
            this.updateSelectorInfo();
        };
        
        // TIKTOK SELECTOR
        app.initTikTokSelector = function() {
            this.updateTikTokCard();
        };
        
        app.updateTikTokCard = function() {
            const group = this.groupsList[this.tiktokIndex];
            const card = document.getElementById('tiktokCard');
            const status = document.getElementById('tiktokStatus');
            const isSelected = this.selectedGroups.has(group.nombre);
            
            card.innerHTML = `
                <div style="font-size: 1rem; font-weight: 600;">${group.nombre}</div>
                <div style="font-size: 0.75rem; opacity: 0.8;">${group.promedio.toFixed(1)}%</div>
                <div style="font-size: 0.7rem; margin-top: 0.5rem;">
                    <span>${isSelected ? '‚úÖ Seleccionado' : '‚ùå Tap to select'}</span>
                </div>
            `;
            
            card.onclick = () => this.toggleTikTokGroup();
        };
        
        app.toggleTikTokGroup = function() {
            const group = this.groupsList[this.tiktokIndex];
            if (this.selectedGroups.has(group.nombre)) {
                this.selectedGroups.delete(group.nombre);
            } else if (this.selectedGroups.size < 5) {
                this.selectedGroups.add(group.nombre);
            } else {
                alert('M√°ximo 5 grupos permitidos');
                return;
            }
            this.updateTikTokCard();
            this.updateSelectorInfo();
            this.updateComparisonChart();
            this.renderGroupCards();
            this.renderSmartInsights();
        };
        
        app.tiktokPrev = function() {
            this.tiktokIndex = (this.tiktokIndex - 1 + this.groupsList.length) % this.groupsList.length;
            this.updateTikTokCard();
        };
        
        app.tiktokNext = function() {
            this.tiktokIndex = (this.tiktokIndex + 1) % this.groupsList.length;
            this.updateTikTokCard();
        };
        
        // CARDS SELECTOR
        app.initCardsSelector = function() {
            const container = document.getElementById('selector-cards');
            container.innerHTML = '';
            
            this.groupsList.forEach(group => {
                const isSelected = this.selectedGroups.has(group.nombre);
                const card = document.createElement('div');
                card.className = `mini-card ${isSelected ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="mini-card-name">${group.nombre}</div>
                    <div class="mini-card-check">‚úì</div>
                `;
                
                card.onclick = () => this.toggleCardGroup(group.nombre, card);
                container.appendChild(card);
            });
        };
        
        app.toggleCardGroup = function(groupName, cardElement) {
            if (this.selectedGroups.has(groupName)) {
                this.selectedGroups.delete(groupName);
                cardElement.classList.remove('selected');
            } else if (this.selectedGroups.size < 5) {
                this.selectedGroups.add(groupName);
                cardElement.classList.add('selected');
            } else {
                alert('M√°ximo 5 grupos permitidos');
                return;
            }
            this.updateSelectorInfo();
            this.updateComparisonChart();
            this.renderGroupCards();
            this.renderSmartInsights();
        };
        
        // SLIDER SELECTOR
        app.initSliderSelector = function() {
            const track = document.getElementById('sliderTrack');
            track.innerHTML = '';
            
            this.groupsList.forEach(group => {
                const isSelected = this.selectedGroups.has(group.nombre);
                const item = document.createElement('div');
                item.className = `slider-item ${isSelected ? 'selected' : ''}`;
                item.innerHTML = `
                    <div style="font-weight: 600; font-size: 0.8rem;">${group.nombre}</div>
                    <div style="font-size: 0.7rem; margin-top: 0.25rem;">${group.promedio.toFixed(1)}%</div>
                `;
                
                item.onclick = () => this.toggleSliderGroup(group.nombre, item);
                track.appendChild(item);
            });
        };
        
        app.toggleSliderGroup = function(groupName, itemElement) {
            if (this.selectedGroups.has(groupName)) {
                this.selectedGroups.delete(groupName);
                itemElement.classList.remove('selected');
            } else if (this.selectedGroups.size < 5) {
                this.selectedGroups.add(groupName);
                itemElement.classList.add('selected');
            } else {
                alert('M√°ximo 5 grupos permitidos');
                return;
            }
            this.updateSelectorInfo();
            this.updateComparisonChart();
            this.renderGroupCards();
            this.renderSmartInsights();
        };
        
        app.sliderPrev = function() {
            const track = document.getElementById('sliderTrack');
            this.sliderOffset = Math.max(0, this.sliderOffset - 120);
            track.style.transform = `translateX(-${this.sliderOffset}px)`;
        };
        
        app.sliderNext = function() {
            const track = document.getElementById('sliderTrack');
            const maxOffset = Math.max(0, (this.groupsList.length * 130) - 300);
            this.sliderOffset = Math.min(maxOffset, this.sliderOffset + 120);
            track.style.transform = `translateX(-${this.sliderOffset}px)`;
        };
        
        // ORIGINAL SELECTOR
        app.initOriginalSelector = function() {
            const container = document.getElementById('selector-original');
            if (container.children.length === 0) {
                this.groupsList.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'group-checkbox';
                    if (this.selectedGroups.has(group.nombre)) {
                        div.classList.add('selected');
                    }
                    
                    div.innerHTML = `
                        <input type="checkbox" id="group_${group.nombre}" 
                               ${this.selectedGroups.has(group.nombre) ? 'checked' : ''}>
                        <label for="group_${group.nombre}">${group.nombre}</label>
                    `;
                    
                    div.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        
                        const checkbox = div.querySelector('input');
                        if (checkbox.checked && this.selectedGroups.size < 5) {
                            this.selectedGroups.add(group.nombre);
                            div.classList.add('selected');
                        } else if (!checkbox.checked) {
                            this.selectedGroups.delete(group.nombre);
                            div.classList.remove('selected');
                        } else {
                            checkbox.checked = false;
                            alert('M√°ximo 5 grupos permitidos');
                            return;
                        }
                        
                        this.updateSelectorInfo();
                        this.updateComparisonChart();
                        this.renderGroupCards();
                        this.renderSmartInsights();
                    });
                    
                    container.appendChild(div);
                });
            }
        };
        
        app.updateSelectorInfo = function() {
            const info = document.getElementById('selectorInfo');
            info.textContent = `Seleccionados: ${this.selectedGroups.size}/5 grupos`;
        };
        
        // Initialize groups list
        app.initGroupsList = function() {
            this.groupsList = Object.keys(this.data.grupos).map(grupo => {
                const valores = this.data.grupos[grupo].filter(v => v !== null);
                const promedio = valores.length > 0 ? valores.reduce((a, b) => a + b, 0) / valores.length : 0;
                return { nombre: grupo, promedio: promedio };
            }).sort((a, b) => b.promedio - a.promedio);
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            app.initGroupsList();
            app.init();
        });
        
        app.init = function() {
            this.setupTabs();
            this.setupTouch();
            this.updateLastUpdate();
            this.renderAllTabs();
            
            // Show swipe hint
            setTimeout(() => {
                document.getElementById('swipeIndicator').classList.add('show');
                setTimeout(() => {
                    document.getElementById('swipeIndicator').classList.remove('show');
                }, 3000);
            }, 1000);
        };
        
        app.setupTabs = function() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    this.switchToTab(tabName);
                });
            });
        };
        
        app.switchToTab = function(tabName) {
            // Update active states
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activate by data-tab name
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            const activeContent = document.getElementById(tabName);
            
            if (activeTab && activeContent) {
                activeTab.classList.add('active');
                activeContent.classList.add('active');
                
                // Update current tab index for swipe
                this.currentTab = this.tabs.indexOf(tabName);
                
                // Render content
                this.renderTabContent(tabName);
            }
        };
        
        app.switchTab = function(index) {
            // Legacy function for swipe navigation
            if (index >= 0 && index < this.tabs.length) {
                this.switchToTab(this.tabs[index]);
            }
        };
        
        app.setupTouch = function() {
            const content = document.querySelector('.content');
            
            // Swipe detection
            content.addEventListener('touchstart', (e) => {
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
                this.pullStartY = window.scrollY === 0 ? e.touches[0].clientY : 0;
            });
            
            content.addEventListener('touchmove', (e) => {
                if (this.pullStartY && e.touches[0].clientY > this.pullStartY + 50) {
                    this.isPulling = true;
                    document.getElementById('pullToRefresh').classList.add('active');
                }
            });
            
            content.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = this.touchStartX - touchEndX;
                const diffY = Math.abs(this.touchStartY - touchEndY);
                
                // Pull to refresh
                if (this.isPulling) {
                    this.refresh();
                    document.getElementById('pullToRefresh').classList.remove('active');
                    this.isPulling = false;
                    return;
                }
                
                // Swipe detection
                if (Math.abs(diffX) > 50 && diffY < 100) {
                    if (diffX > 0 && this.currentTab < this.tabs.length - 1) {
                        // Swipe left - next tab
                        this.switchTab(this.currentTab + 1);
                    } else if (diffX < 0 && this.currentTab > 0) {
                        // Swipe right - previous tab
                        this.switchTab(this.currentTab - 1);
                    }
                }
            });
        };
        
        app.updateLastUpdate = function() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-MX', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdate').textContent = timeStr;
        };
        
        app.refresh = async function() {
            // Show loading state
            const indicator = document.getElementById('pullToRefresh');
            indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Update data and charts
            this.updateLastUpdate();
            this.renderTabContent(this.tabs[this.currentTab]);
            
            // Reset indicator
            indicator.innerHTML = '<i class="fas fa-sync-alt"></i>';
        };
        
        app.renderAllTabs = function() {
            this.renderAlerts();
            this.renderSmartAnalysis();
            this.renderHeatMap();
            this.renderTrends();
        };
        
        app.renderTabContent = function(tabName) {
            switch(tabName) {
                case 'alerts': this.renderAlerts(); break;
                case 'smart': this.renderSmartAnalysis(); break;
                case 'heatmap': this.renderHeatMap(); break;
                case 'trends': this.renderTrends(); break;
            }
        };
        
        app.renderAlerts = function() {
            // Summary chart
            const ctx = document.getElementById('summaryChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.charts.summary) this.charts.summary.destroy();
            
            this.charts.summary = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Excelente', 'Bueno', 'Regular', 'Cr√≠tico'],
                    datasets: [{
                        data: [3, 8, 6, 3],
                        backgroundColor: ['#00b894', '#74b9ff', '#fdcb6e', '#d63031']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        };
        
        app.renderSmartAnalysis = function() {
            // Initialize current selector
            this.initSelector(this.selectorStyle);
            this.updateComparisonChart();
            this.renderGroupCards();
            this.renderSmartInsights();
        };
        
        app.updateComparisonChart = function() {
            const ctx = document.getElementById('comparisonChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.charts.comparison) this.charts.comparison.destroy();
            
            // Calculate EPL CAS cumulative averages for the chart
            const eplPromedios = this.data.periodos.map((periodo, currentIndex) => {
                let suma = 0;
                let count = 0;
                
                Object.values(this.data.grupos).forEach(valores => {
                    for (let i = 0; i <= currentIndex; i++) {
                        if (valores[i] !== null) {
                            suma += valores[i];
                            count++;
                        }
                    }
                });
                
                return count > 0 ? suma / count : null;
            });
            
            const datasets = [];
            
            // Add EPL CAS line first (dotted)
            datasets.push({
                label: 'EPL CAS Promedio',
                data: eplPromedios,
                borderColor: '#FF6B35',
                backgroundColor: 'rgba(255, 107, 53, 0.1)',
                borderWidth: 3,
                borderDash: [5, 5],
                tension: 0.2,
                pointBackgroundColor: '#FF6B35',
                pointBorderColor: '#FF6B35',
                pointRadius: 4,
                fill: false
            });
            
            // Add selected groups
            Array.from(this.selectedGroups).forEach((grupo, index) => {
                datasets.push({
                    label: grupo,
                    data: this.data.grupos[grupo],
                    borderColor: `hsl(${index * 60 + 30}, 70%, 50%)`,
                    backgroundColor: `hsla(${index * 60 + 30}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: `hsl(${index * 60 + 30}, 70%, 50%)`,
                    pointBorderColor: `hsl(${index * 60 + 30}, 70%, 50%)`,
                    pointRadius: 3
                });
            });
            
            this.charts.comparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: this.data.periodos,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontSize: 12,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 60,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Performance (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Per√≠odos'
                            }
                        }
                    }
                }
            });
        };
        
        app.renderGroupCards = function() {
            const container = document.getElementById('groupCards');
            if (!container) return;
            
            container.innerHTML = '';
            
            Array.from(this.selectedGroups).forEach(grupo => {
                const detalle = this.data.gruposDetallados[grupo];
                if (!detalle) return;
                
                const card = document.createElement('div');
                card.className = 'group-card';
                card.innerHTML = `
                    <div class="group-card-header" onclick="app.toggleCard('${grupo}')">
                        <div class="group-card-title">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${this.getGroupColor(grupo)};"></div>
                            <strong>${grupo}</strong>
                        </div>
                        <div class="group-card-metrics">
                            <span style="font-weight: 600;">${detalle.promedio_general.toFixed(1)}%</span>
                            <span style="color: #636e72;">üìç ${detalle.total_sucursales} suc</span>
                            <span class="trend-indicator trend-${detalle.tendencia}">
                                ${detalle.tendencia === 'mejorando' ? '‚Üó' : detalle.tendencia === 'declinando' ? '‚Üò' : '‚Üí'} 
                                ${detalle.vs_epl_cas > 0 ? '+' : ''}${detalle.vs_epl_cas.toFixed(1)}% vs EPL
                            </span>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="group-card-content">
                        <div class="metric-item">
                            <span class="metric-label">Promedio General:</span>
                            <span class="metric-value">${detalle.promedio_general.toFixed(1)}%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">vs EPL CAS:</span>
                            <span class="metric-value" style="color: ${detalle.vs_epl_cas > 0 ? '#00b894' : '#d63031'};">
                                ${detalle.vs_epl_cas > 0 ? '+' : ''}${detalle.vs_epl_cas.toFixed(1)}%
                            </span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Tendencia:</span>
                            <span class="metric-value">${detalle.tendencia}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Volatilidad:</span>
                            <span class="metric-value">${detalle.volatilidad}</span>
                        </div>
                        
                        <div class="sucursales-list">
                            <h4 style="font-size: 0.8rem; margin-bottom: 0.5rem; color: var(--primary);">üìç Sucursales Evaluadas:</h4>
                            ${Object.entries(detalle.periodos).map(([periodo, data]) => `
                                <div class="periodo-section">
                                    <div class="periodo-title">${periodo}: ${data.promedio.toFixed(1)}%</div>
                                    ${data.sucursales.map(suc => `
                                        <div class="sucursal-item">
                                            <span>${suc.nombre}</span>
                                            <span style="font-weight: 600;">${suc.calificacion.toFixed(1)}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        };
        
        app.toggleCard = function(grupo) {
            const cards = document.querySelectorAll('.group-card');
            cards.forEach(card => {
                if (card.innerHTML.includes(grupo)) {
                    card.classList.toggle('expanded');
                }
            });
        };
        
        app.getGroupColor = function(grupo) {
            const groups = Array.from(this.selectedGroups);
            const index = groups.indexOf(grupo);
            return `hsl(${index * 60 + 30}, 70%, 50%)`;
        };
        
        app.renderSmartInsights = function() {
            const container = document.getElementById('smartInsights');
            if (!container) return;
            
            const insights = [];
            
            Array.from(this.selectedGroups).forEach(grupo => {
                const detalle = this.data.gruposDetallados[grupo];
                if (!detalle) return;
                
                if (detalle.vs_epl_cas > 5) {
                    insights.push(`${grupo} supera constantemente el EPL CAS (+${detalle.vs_epl_cas.toFixed(1)}% promedio)`);
                } else if (detalle.vs_epl_cas < -5) {
                    insights.push(`${grupo} est√° por debajo del EPL CAS (${detalle.vs_epl_cas.toFixed(1)}% promedio)`);
                }
                
                if (detalle.volatilidad === 'alta') {
                    insights.push(`${grupo} muestra alta volatilidad - requiere seguimiento`);
                }
                
                if (detalle.tendencia === 'mejorando') {
                    insights.push(`${grupo} muestra tendencia positiva - buen desempe√±o`);
                } else if (detalle.tendencia === 'declinando') {
                    insights.push(`${grupo} muestra tendencia negativa - requiere intervenci√≥n`);
                }
            });
            
            if (insights.length === 0) {
                container.innerHTML = '<p style="color: #636e72; font-style: italic;">Selecciona grupos para ver insights autom√°ticos</p>';
            } else {
                container.innerHTML = `
                    <ul style="padding-left: 1.5rem; font-size: 0.875rem;">
                        ${insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                `;
            }
        };
        
        app.renderHeatMap = function(filter = 'all') {
            const tbody = document.getElementById('heatmapBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const showDifferences = document.getElementById('showDifferences')?.checked ?? true;
            
            // Calculate EPL CAS cumulative averages (all supervisions up to that period)
            const eplPromedios = this.data.periodos.map((periodo, currentIndex) => {
                let suma = 0;
                let count = 0;
                
                // Sum ALL supervisions from period 0 up to currentIndex (cumulative)
                Object.values(this.data.grupos).forEach(valores => {
                    for (let i = 0; i <= currentIndex; i++) {
                        if (valores[i] !== null) {
                            suma += valores[i];
                            count++;
                        }
                    }
                });
                
                return count > 0 ? suma / count : 0;
            });
            
            // Calculate overall EPL average
            const eplPromedioGeneral = eplPromedios.filter(p => p > 0).reduce((a, b) => a + b, 0) / 
                                      eplPromedios.filter(p => p > 0).length;
            
            // Calculate averages and trends for groups
            const gruposConDatos = Object.entries(this.data.grupos).map(([grupo, valores]) => {
                const valoresValidos = valores.filter(v => v !== null);
                const promedio = valoresValidos.length > 0 
                    ? valoresValidos.reduce((a, b) => a + b, 0) / valoresValidos.length 
                    : 0;
                
                // Calculate overall trend
                let trend = 'stable';
                if (valoresValidos.length >= 2) {
                    const firstValue = valoresValidos[0];
                    const lastValue = valoresValidos[valoresValidos.length - 1];
                    const diff = lastValue - firstValue;
                    if (diff > 2) trend = 'improving';
                    else if (diff < -2) trend = 'declining';
                }
                
                // Check if critical
                const isCritical = valoresValidos.some(v => v < 75);
                
                return { grupo, valores, promedio, trend, isCritical };
            });
            
            // Apply filter
            let gruposFiltrados = gruposConDatos;
            switch(filter) {
                case 'critical':
                    gruposFiltrados = gruposConDatos.filter(g => g.isCritical);
                    break;
                case 'improving':
                    gruposFiltrados = gruposConDatos.filter(g => g.trend === 'improving');
                    break;
                case 'declining':
                    gruposFiltrados = gruposConDatos.filter(g => g.trend === 'declining');
                    break;
            }
            
            // Sort by average
            gruposFiltrados.sort((a, b) => b.promedio - a.promedio);
            
            // Add EPL CAS average row first
            const eplRow = document.createElement('tr');
            eplRow.className = 'epl-row';
            
            // EPL CAS label cell
            const eplLabelCell = document.createElement('td');
            eplLabelCell.innerHTML = `
                <div style="color: black; font-weight: bold; font-size: 0.8rem; text-align: center;">
                    Promedio EPL CAS
                </div>
            `;
            eplRow.appendChild(eplLabelCell);
            
            // EPL period cells
            let lastValidEpl = null;
            eplPromedios.forEach((promedio, index) => {
                const cell = document.createElement('td');
                
                if (promedio === 0) {
                    cell.innerHTML = '‚Äî';
                } else {
                    let cellContent = `<div>${promedio.toFixed(1)}%</div>`;
                    
                    // Add difference vs previous EPL period if enabled
                    if (showDifferences && lastValidEpl !== null) {
                        const diff = promedio - lastValidEpl;
                        const diffClass = diff > 0 ? 'diff-positive' : 'diff-negative';
                        const diffSign = diff > 0 ? '+' : '';
                        const trendSymbol = diff > 0 ? '‚Üó' : diff < 0 ? '‚Üò' : '‚Üí';
                        
                        cellContent += `<div class="diff-value ${diffClass}" style="color: rgba(255,255,255,0.8);">${trendSymbol} ${diffSign}${diff.toFixed(1)}</div>`;
                    }
                    
                    // Add tooltip explaining cumulative average
                    cell.title = `Promedio EPL CAS acumulativo hasta ${this.data.periodos[index]}: incluye todas las supervisiones desde el inicio hasta este per√≠odo`;
                    cell.innerHTML = cellContent;
                    lastValidEpl = promedio;
                }
                
                eplRow.appendChild(cell);
            });
            
            // EPL overall average cell
            const eplAvgCell = document.createElement('td');
            eplAvgCell.innerHTML = `${eplPromedioGeneral.toFixed(1)}%`;
            eplRow.appendChild(eplAvgCell);
            
            tbody.appendChild(eplRow);
            
            // Render each group
            gruposFiltrados.forEach(({ grupo, valores, promedio }) => {
                const row = document.createElement('tr');
                
                // Group name cell
                const groupCell = document.createElement('td');
                groupCell.textContent = grupo;
                row.appendChild(groupCell);
                
                // Track previous non-null value for differences
                let lastValidValue = null;
                let lastValidIndex = -1;
                
                // Period cells
                valores.forEach((valor, index) => {
                    const cell = document.createElement('td');
                    
                    if (valor === null) {
                        cell.className = 'heat-none';
                        cell.textContent = '‚Äî';
                    } else {
                        // Apply color based on new scale
                        if (valor >= 95) cell.className = 'heat-excelente';
                        else if (valor >= 91) cell.className = 'heat-muy-bueno';
                        else if (valor >= 87) cell.className = 'heat-bueno';
                        else if (valor >= 82) cell.className = 'heat-regular';
                        else cell.className = 'heat-critico';
                        
                        // Main value - clean without emojis
                        let cellContent = `<div style="font-weight: 600;">${valor.toFixed(1)}%</div>`;
                        
                        // Add difference if enabled and there's a previous value
                        if (showDifferences && lastValidValue !== null) {
                            const diff = valor - lastValidValue;
                            const diffClass = diff > 0 ? 'diff-positive' : 'diff-negative';
                            const diffSign = diff > 0 ? '+' : '';
                            const trendSymbol = diff > 0 ? '‚Üó' : diff < 0 ? '‚Üò' : '‚Üí';
                            
                            cellContent += `<div class="diff-value ${diffClass}">${trendSymbol} ${diffSign}${diff.toFixed(1)}</div>`;
                        }
                        
                        cell.innerHTML = cellContent;
                        
                        // Update last valid value
                        lastValidValue = valor;
                        lastValidIndex = index;
                    }
                    
                    row.appendChild(cell);
                });
                
                // Average cell
                const avgCell = document.createElement('td');
                avgCell.style.fontWeight = 'bold';
                if (promedio >= 95) avgCell.className = 'heat-excelente';
                else if (promedio >= 91) avgCell.className = 'heat-muy-bueno';
                else if (promedio >= 87) avgCell.className = 'heat-bueno';
                else if (promedio >= 82) avgCell.className = 'heat-regular';
                else avgCell.className = 'heat-critico';
                avgCell.textContent = promedio.toFixed(1) + '%';
                row.appendChild(avgCell);
                
                tbody.appendChild(row);
            });
            
            // Setup filter buttons if not already done
            if (!this.filtersSetup) {
                this.setupHeatmapFilters();
                this.filtersSetup = true;
            }
        };
        
        app.setupHeatmapFilters = function() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active state
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Apply filter
                    const filter = btn.dataset.filter;
                    this.renderHeatMap(filter);
                });
            });
            
            // Differences toggle
            document.getElementById('showDifferences')?.addEventListener('change', () => {
                // Re-render with current filter
                const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                this.renderHeatMap(activeFilter);
            });
        };
        
        app.renderTrends = function() {
            // Evolution chart
            const ctx = document.getElementById('evolutionChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.charts.evolution) this.charts.evolution.destroy();
            
            // Calculate trends
            const trendData = this.calculateTrends();
            
            this.charts.evolution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: this.data.periodos,
                    datasets: [{
                        label: 'Promedio de Red',
                        type: 'line',
                        data: [88.5, 86.2, 87.8, 88.6, 89.1],
                        borderColor: '#ff6b35',
                        borderWidth: 3,
                        fill: false
                    }, {
                        label: 'Grupos Evaluados',
                        data: [10, 12, 15, 13, 11],
                        backgroundColor: 'rgba(116, 185, 255, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Trend analysis
            const analysis = document.getElementById('trendAnalysis');
            if (analysis) {
                analysis.innerHTML = `
                    <div style="font-size: 0.875rem; line-height: 1.5;">
                        <p><strong>üìà Tendencia General:</strong> Mejora de +0.6% en los √∫ltimos 3 per√≠odos</p>
                        <p><strong>üéØ Proyecci√≥n:</strong> Se espera alcanzar 90% en el pr√≥ximo per√≠odo</p>
                        <p><strong>‚ö†Ô∏è Atenci√≥n:</strong> 3 grupos requieren intervenci√≥n inmediata</p>
                    </div>
                `;
            }
        };
        
        app.calculateTrends = function() {
            // Placeholder for trend calculation
            return {
                improving: 12,
                declining: 5,
                stable: 3
            };
        };
        
        // TODO: Add real API integration
        app.loadRealData = async function() {
            try {
                const response = await fetch('/api/historico/data');
                const data = await response.json();
                this.data = data;
                this.renderAllTabs();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        };
    </script>
</body>
</html>