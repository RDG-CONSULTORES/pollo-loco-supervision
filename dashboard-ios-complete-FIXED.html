<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <title>El Pollo Loco CAS - Dashboard Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* iOS System Colors */
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-yellow: #FFCC00;
            --ios-orange: #FF9500;
            --ios-gray: #8E8E93;
            --ios-gray-2: #AEAEB2;
            --ios-gray-3: #C7C7CC;
            --ios-gray-4: #D1D1D6;
            --ios-gray-5: #E5E5EA;
            --ios-gray-6: #F2F2F7;
            --ios-background: #F2F2F7;
            --ios-secondary-background: #FFFFFF;
            --ios-grouped-background: #F2F2F7;
            --ios-label: #000000;
            --ios-secondary-label: #3C3C43;
            --ios-tertiary-label: #3C3C43;
            --ios-quaternary-label: #3C3C43;
            --ios-separator: rgba(60, 60, 67, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background: var(--ios-background);
            color: var(--ios-label);
            line-height: 1.47059;
            font-size: 17px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 90px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: rgba(242, 242, 247, 0.94);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 0.5px solid var(--ios-separator);
            padding: 0 16px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label);
            text-align: center;
            flex: 1;
        }

        .nav-button {
            color: var(--ios-blue);
            font-size: 17px;
            font-weight: 400;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        /* Large Title */
        .large-title-container {
            background: var(--ios-background);
            padding: 8px 16px 0;
        }

        .large-title {
            font-size: 34px;
            font-weight: 700;
            color: var(--ios-label);
            margin-bottom: 8px;
        }

        /* Segmented Control */
        .segmented-control {
            background: rgba(118, 118, 128, 0.12);
            border-radius: 9px;
            padding: 2px;
            display: flex;
            margin: 16px;
            height: 32px;
        }

        .segment {
            flex: 1;
            background: transparent;
            border: none;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            color: var(--ios-label);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 12px;
        }

        .segment.active {
            background: var(--ios-secondary-background);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(242, 242, 247, 0.94);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--ios-separator);
            padding: 8px 0 32px;
            display: flex;
            z-index: 1000;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 8px;
            color: var(--ios-gray);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .tab.active {
            color: var(--ios-blue);
        }

        .tab i {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .tab span {
            font-size: 10px;
            font-weight: 600;
        }

        /* Tab Views */
        .tab-view {
            display: none;
        }

        .tab-view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 16px 16px 8px;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-label);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--ios-secondary-label);
        }

        .card-content {
            padding: 16px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 16px;
        }

        .kpi-card {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--ios-blue);
            margin-bottom: 4px;
        }

        .kpi-label {
            font-size: 13px;
            color: var(--ios-secondary-label);
            font-weight: 600;
        }

        /* List Items */
        .list-container {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 0.5px solid var(--ios-separator);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: var(--ios-gray-6);
        }

        .list-item .rank {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background: var(--ios-gray-5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 12px;
        }

        .list-item.rank-1 .rank { background: #FFD700; color: #000; }
        .list-item.rank-2 .rank { background: #C0C0C0; color: #000; }
        .list-item.rank-3 .rank { background: #CD7F32; color: #fff; }
        .list-item.rank-good .rank { background: var(--ios-green); color: #fff; }
        .list-item.rank-warning .rank { background: var(--ios-yellow); color: #000; }
        .list-item.rank-critical .rank { background: var(--ios-red); color: #fff; }

        .list-item .info {
            flex: 1;
        }

        .list-item .name {
            font-size: 16px;
            font-weight: 600;
            color: var(--ios-label);
            margin-bottom: 2px;
        }

        .list-item .details {
            font-size: 13px;
            color: var(--ios-secondary-label);
        }

        .list-item .performance {
            font-size: 18px;
            font-weight: 700;
            margin-left: 12px;
        }

        .list-item .performance.excellent { color: var(--ios-green); }
        .list-item .performance.good { color: var(--ios-blue); }
        .list-item .performance.critical { color: var(--ios-red); }

        /* Filter Pills */
        .filters-section {
            margin: 16px;
        }

        .filter-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--ios-label);
            margin-bottom: 8px;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-pill {
            background: var(--ios-gray-5);
            color: var(--ios-label);
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-pill.active,
        .filter-pill:hover {
            background: var(--ios-blue);
            color: white;
        }

        .grupo-select {
            width: 100%;
            background: var(--ios-secondary-background);
            border: 1px solid var(--ios-separator);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            color: var(--ios-label);
            margin-bottom: 16px;
        }

        /* Map Styles */
        .map-container {
            position: relative;
            background: var(--ios-secondary-background);
            border-radius: 10px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: 300px;
            transition: all 0.3s ease;
        }

        .map-container.collapsed {
            height: 80vh;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-fullscreen-btn {
            position: absolute;
            top: 8px;
            right: 16px;
            background: var(--ios-secondary-background);
            border: 0.5px solid var(--ios-separator);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--ios-blue);
            z-index: 1000;
        }

        .map-list-container {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .map-list-container.expanded {
            max-height: 50vh;
        }

        .map-drag-handle {
            background: var(--ios-gray-4);
            height: 4px;
            width: 40px;
            border-radius: 2px;
            margin: 8px auto;
            cursor: grab;
            transition: background-color 0.2s ease;
        }

        .map-drag-handle:hover {
            background: var(--ios-gray-3);
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 16px 0;
        }

        /* Heatmap Styles */
        .heatmap-container {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .heatmap-table th {
            background: var(--ios-gray-6);
            padding: 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--ios-separator);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .heatmap-table td {
            padding: 6px;
            text-align: center;
            border: 1px solid var(--ios-separator);
            font-weight: 500;
        }

        .heat-excelente { background-color: #d4edda; }
        .heat-muy-bueno { background-color: #b8dce8; }
        .heat-bueno { background-color: #e2f3ff; }
        .heat-regular { background-color: #fff3cd; }
        .heat-critico { background-color: #f8d7da; }

        .epl-cas-row {
            background-color: var(--ios-blue) !important;
            color: white !important;
            font-weight: 700;
        }

        .epl-cas-row td {
            background-color: var(--ios-blue) !important;
            color: white !important;
        }

        .diff-positive {
            color: var(--ios-green);
            font-weight: 600;
        }

        .diff-negative {
            color: var(--ios-red);
            font-weight: 600;
        }

        /* Alert Styles */
        .alert-card {
            background: var(--ios-secondary-background);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .alert-card.critical {
            border-left-color: var(--ios-red);
        }

        .alert-card.warning {
            border-left-color: var(--ios-yellow);
        }

        .alert-card.info {
            border-left-color: var(--ios-blue);
        }

        .alert-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-description {
            font-size: 14px;
            color: var(--ios-secondary-label);
            margin-bottom: 8px;
        }

        .alert-time {
            font-size: 12px;
            color: var(--ios-gray);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--ios-gray);
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* View Mode Toggle */
        .view-mode-toggle {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            border-radius: 8px;
            padding: 2px;
            margin: 16px;
        }

        .view-mode-button {
            flex: 1;
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-mode-button.active {
            background: var(--ios-secondary-background);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .large-title {
                font-size: 28px;
            }
            
            .filter-pills {
                font-size: 12px;
            }
        }

        /* Heatmap filters */
        .heatmap-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px;
        }

        .heatmap-filter-btn {
            background: var(--ios-gray-5);
            color: var(--ios-label);
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-filter-btn.active,
        .heatmap-filter-btn:hover {
            background: var(--ios-blue);
            color: white;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px;
            padding: 12px;
            background: var(--ios-secondary-background);
            border-radius: 8px;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--ios-label);
        }

        /* Charts view styles */
        .charts-view {
            display: none;
        }

        .charts-view.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <button class="nav-button" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i>
        </button>
        <div class="nav-title" id="nav-title">Dashboard CAS</div>
        <button class="nav-button" onclick="resetFilters()">
            <i class="fas fa-filter"></i>
        </button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-view" class="tab-view active">
        <!-- Large Title -->
        <div class="large-title-container">
            <div class="large-title">Supervisiones</div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="performance-general">--%</div>
                <div class="kpi-label">Performance General</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="total-supervisiones">--</div>
                <div class="kpi-label">Total Supervisiones</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="total-grupos">--</div>
                <div class="kpi-label">Grupos Activos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="grupos-criticos">--</div>
                <div class="kpi-label">Sucursales Evaluadas</div>
            </div>
        </div>

        <!-- View Mode Toggle -->
        <div class="view-mode-toggle">
            <button class="view-mode-button active" onclick="switchViewMode('list')">
                <i class="fas fa-list"></i> Lista
            </button>
            <button class="view-mode-button" onclick="switchViewMode('chart')">
                <i class="fas fa-chart-bar"></i> Gr√°ficas
            </button>
        </div>

        <!-- Segmented Control -->
        <div class="segmented-control">
            <button class="segment active" onclick="switchView('general')">General</button>
            <button class="segment" onclick="switchView('grupos')">Grupos</button>
            <button class="segment" onclick="switchView('criticos')">Cr√≠ticos</button>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-title">Filtros por Estado</div>
            <div class="filter-pills" id="estado-filters">
                <button class="filter-pill active" data-value="all">Todos</button>
            </div>

            <div class="filter-title">Grupo Operativo</div>
            <select class="grupo-select" id="grupo-select">
                <option value="">Todos los grupos</option>
            </select>
        </div>

        <!-- General View -->
        <div id="general-view">
            <!-- Top Performers -->
            <div class="list-container">
                <div class="card-header">
                    <div class="card-title">Top Performers</div>
                    <div class="card-subtitle">Mejores grupos operativos</div>
                </div>
                <div id="top-performers">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        Cargando...
                    </div>
                </div>
            </div>

            <!-- Critical Performers -->
            <div class="list-container">
                <div class="card-header">
                    <div class="card-title">Requieren Atenci√≥n</div>
                    <div class="card-subtitle">Grupos con performance cr√≠tico</div>
                </div>
                <div id="critical-performers">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        Cargando...
                    </div>
                </div>
            </div>
        </div>

        <!-- Grupos View -->
        <div id="grupos-view" style="display: none;">
            <div class="list-view">
                <div class="list-container">
                    <div class="card-header">
                        <div class="card-title">Todos los Grupos</div>
                        <div class="card-subtitle">Ranking completo por performance</div>
                    </div>
                    <div id="all-grupos">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            Cargando...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-view" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance por Grupo</div>
                        <div class="card-subtitle">Visualizaci√≥n en gr√°ficas</div>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="gruposChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cr√≠ticos View -->
        <div id="criticos-view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">An√°lisis de Grupos Cr√≠ticos</div>
                    <div class="card-subtitle">Performance < 80%</div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="criticalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts View -->
        <div id="charts-view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Distribuci√≥n de Performance</div>
                    <div class="card-subtitle">Grupos por categor√≠a</div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Ranking Horizontal</div>
                    <div class="card-subtitle">Top 10 grupos</div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="horizontalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Tab -->
    <div id="mapa-view" class="tab-view">
        <div class="large-title-container">
            <div class="large-title">Mapa</div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <button class="map-fullscreen-btn" id="map-fullscreen-btn" onclick="toggleMapFullscreen()">
                <i class="fas fa-expand"></i>
            </button>
        </div>

        <div class="map-list-container" id="map-list-container">
            <div class="map-drag-handle" id="map-drag-handle"></div>
            <div class="card-header">
                <div class="card-title">Sucursales en Mapa</div>
                <div class="card-subtitle" id="map-subtitle">Todas las ubicaciones</div>
            </div>
            <div id="sucursales-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    Cargando ubicaciones...
                </div>
            </div>
        </div>
    </div>

    <!-- Hist√≥rico Tab -->
    <div id="tendencias-view" class="tab-view">
        <div class="large-title-container">
            <div class="large-title">Hist√≥rico</div>
        </div>

        <!-- Heatmap Filters -->
        <div class="heatmap-filters">
            <button class="heatmap-filter-btn active" data-filter="all">Todos los Grupos</button>
            <button class="heatmap-filter-btn" data-filter="critical">Cr√≠ticos <80%</button>
            <button class="heatmap-filter-btn" data-filter="improving">Mejorando</button>
            <button class="heatmap-filter-btn" data-filter="declining">Declinando</button>
        </div>

        <!-- Toggle Differences -->
        <div class="toggle-container">
            <input type="checkbox" id="showDifferences" checked>
            <label class="toggle-label" for="showDifferences">Mostrar Diferencias</label>
        </div>

        <!-- Heatmap Table -->
        <div class="heatmap-container">
            <div style="overflow-x: auto; max-height: 70vh;">
                <table class="heatmap-table">
                    <thead>
                        <tr id="heatmapHeader">
                            <th>Grupo Operativo</th>
                        </tr>
                    </thead>
                    <tbody id="heatmapBody">
                        <tr>
                            <td colspan="100%" style="text-align: center; padding: 40px;">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    Cargando datos hist√≥ricos...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alertas Tab -->
    <div id="alertas-view" class="tab-view">
        <div class="large-title-container">
            <div class="large-title">Alertas</div>
        </div>

        <div class="card-content" id="alertas-container">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                Cargando alertas...
            </div>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('dashboard')">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
        </div>
        <div class="tab" onclick="switchTab('mapa')">
            <i class="fas fa-map-marker-alt"></i>
            <span>Mapa</span>
        </div>
        <div class="tab" onclick="switchTab('tendencias')">
            <i class="fas fa-chart-area"></i>
            <span>Hist√≥rico</span>
        </div>
        <div class="tab" onclick="switchTab('alertas')">
            <i class="fas fa-bell"></i>
            <span>Alertas</span>
        </div>
    </div>

    <script>
        // ==================================================================================
        // VARIABLES GLOBALES
        // ==================================================================================
        
        let allGroups = [];
        let allGroupsComplete = [];
        let allSucursales = [];
        let mapData = [];
        let currentView = 'general';
        let currentTab = 'dashboard';
        let currentViewMode = 'list';
        let currentFilters = {
            periodo: 'all',
            performance: 'all',
            estado: 'all',
            grupo: ''
        };
        let kpiData = {};
        let map = null;
        let mapExpanded = false;

        // Charts
        let performanceChart = null;
        let criticalChart = null;
        let gruposChart = null;
        let horizontalChart = null;

        // Heatmap
        let heatmapPeriodsData = null;
        let heatmapCurrentFilter = 'all';

        // API Base - adaptado para la estructura nueva
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:10000/api' 
            : '/api';

        // ==================================================================================
        // INICIALIZACI√ìN
        // ==================================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard iniciando con estructura nueva');
            loadAllGroupsOnce();
            loadData();
            loadEstados();
            initEventListeners();
        });

        // ==================================================================================
        // FUNCIONES DE CARGA DE DATOS
        // ==================================================================================
        
        async function loadAllGroupsOnce() {
            try {
                console.log('üìä Cargando lista completa de grupos...');
                const response = await fetch(`${API_BASE}/grupos`);
                const groupsData = await response.json();
                
                if (groupsData && Array.isArray(groupsData) && groupsData.length > 0) {
                    allGroupsComplete = groupsData.map((group, index) => ({
                        rank: index + 1,
                        name: group.grupo || group.grupo_operativo || 'N/A',
                        performance: parseFloat(group.promedio) || parseFloat(group.promedio_cas_periodo) || 0,
                        supervisiones: group.supervisiones || group.total_supervisiones || 0,
                        estado: group.estado || 'N/A',
                        trend: Math.random() * 20 - 10
                    }));
                }
                console.log('‚úÖ Grupos completos cargados:', allGroupsComplete.length);
            } catch (error) {
                console.error('‚ùå Error loading complete groups:', error);
                allGroupsComplete = [];
            }
        }

        async function loadData() {
            try {
                showLoading();
                console.log('üìä Cargando datos principales...');
                
                allGroups = [];
                updateUI();
                
                // Cargar KPIs desde performance overview
                try {
                    const kpiResponse = await fetch(`${API_BASE}/performance/overview${buildQueryString()}`);
                    kpiData = await kpiResponse.json();
                    updateKPIs();
                    console.log('‚úÖ KPIs cargados:', kpiData);
                } catch (error) {
                    console.error('‚ö†Ô∏è Error loading KPIs:', error);
                    // Usar datos mock si falla
                    kpiData = {
                        promedio_general: 85.2,
                        total_evaluaciones: 1250,
                        grupos_activos: 20,
                        sucursales_evaluadas: 85
                    };
                    updateKPIs();
                }
                
                // Cargar Grupos desde /api/grupos
                try {
                    const groupsResponse = await fetch(`${API_BASE}/grupos${buildQueryString()}`);
                    const groupsData = await groupsResponse.json();
                    
                    if (groupsData && Array.isArray(groupsData) && groupsData.length > 0) {
                        allGroups = groupsData.map((group, index) => ({
                            rank: index + 1,
                            name: group.grupo || group.grupo_operativo || 'N/A',
                            performance: parseFloat(group.promedio) || parseFloat(group.promedio_cas_periodo) || 0,
                            supervisiones: group.supervisiones || group.total_supervisiones || 0,
                            estado: group.estado || 'N/A',
                            trend: Math.random() * 20 - 10
                        }));
                    } else {
                        console.warn('‚ö†Ô∏è No groups data received, using complete groups');
                        allGroups = allGroupsComplete.slice();
                    }
                    console.log('‚úÖ Grupos cargados:', allGroups.length);
                } catch (error) {
                    console.error('‚ö†Ô∏è Error loading groups, using complete groups:', error);
                    allGroups = allGroupsComplete.slice();
                }
                
                populateGroupSelect();
                updateUI();
                initCharts();
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showError('Error al cargar los datos');
                hideLoading();
            }
        }

        async function loadEstados() {
            try {
                console.log('üèõÔ∏è Cargando estados...');
                const response = await fetch(`${API_BASE}/estados`);
                const estados = await response.json();
                
                console.log('‚úÖ Estados cargados:', estados.length);
                
                const estadoFilters = document.getElementById('estado-filters');
                
                // Clear existing filters except "Todos"
                const existingButtons = estadoFilters.querySelectorAll('.filter-pill:not([data-value="all"])');
                existingButtons.forEach(btn => btn.remove());
                
                estados.forEach(estado => {
                    const button = document.createElement('button');
                    button.className = 'filter-pill';
                    button.dataset.value = estado;
                    button.textContent = estado;
                    estadoFilters.appendChild(button);
                });
            } catch (error) {
                console.error('‚ùå Error loading estados:', error);
            }
        }

        // ==================================================================================
        // FUNCIONES DEL MAPA
        // ==================================================================================
        
        async function loadMapData() {
            try {
                console.log('üó∫Ô∏è Cargando datos del mapa...');
                mapData = [];
                
                const response = await fetch(`${API_BASE}/mapa${buildQueryString()}`);
                const data = await response.json();
                
                if (data && Array.isArray(data) && data.length > 0) {
                    mapData = data.map(point => ({
                        ...point,
                        latitud: point.lat || point.latitud,
                        longitud: point.lng || point.longitud,
                        promedio: point.performance || point.promedio || 0,
                        nombre: point.nombre || point.location_name || point.sucursal,
                        promedio_cas_periodo: point.performance || point.promedio || 0
                    }));
                    console.log('‚úÖ Map data cargado:', mapData.length, 'puntos');
                } else {
                    console.warn('‚ö†Ô∏è Map data vac√≠o, usando fallback');
                    await loadMapDataFallback();
                    return;
                }
                
                initMap();
                updateMapStats();
            } catch (error) {
                console.error('‚ùå Error loading map data:', error);
                await loadMapDataFallback();
            }
        }

        async function loadMapDataFallback() {
            try {
                console.log('üîÑ Usando fallback para datos del mapa...');
                
                // Usar coordenadas mock basadas en estados
                const stateCoords = {
                    'Nuevo Le√≥n': { lat: 25.6866, lng: -100.3161 },
                    'Tamaulipas': { lat: 24.2669, lng: -98.8363 },
                    'Quer√©taro': { lat: 20.5888, lng: -100.3899 },
                    'Coahuila': { lat: 27.0587, lng: -101.7068 },
                    'San Luis Potos√≠': { lat: 22.1565, lng: -100.9855 },
                    'Chihuahua': { lat: 28.6330, lng: -106.0691 },
                    'Sonora': { lat: 29.2972, lng: -110.3309 },
                    'Jalisco': { lat: 20.6597, lng: -103.3496 }
                };
                
                mapData = allGroups.slice(0, 20).map((group, index) => {
                    const estados = Object.keys(stateCoords);
                    const randomEstado = estados[index % estados.length];
                    const baseCoords = stateCoords[randomEstado];
                    
                    return {
                        nombre: `Sucursal ${group.name} ${index + 1}`,
                        latitud: baseCoords.lat + (Math.random() - 0.5) * 0.5,
                        longitud: baseCoords.lng + (Math.random() - 0.5) * 0.5,
                        promedio: group.performance,
                        promedio_cas_periodo: group.performance,
                        estado: randomEstado,
                        grupo: group.name,
                        total_supervisiones: group.supervisiones
                    };
                });
                
                console.log('‚úÖ Fallback map data generado:', mapData.length, 'puntos');
                initMap();
                updateMapStats();
            } catch (error) {
                console.error('‚ùå Error en fallback map data:', error);
                mapData = [];
            }
        }

        function initMap() {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            if (map) {
                map.eachLayer(function(layer) {
                    if (layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
            }
            
            if (mapData.length === 0) {
                updateSucursalesList();
                return;
            }
            
            if (!map) {
                map = L.map('map').setView([25.6866, -100.3161], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }
            
            mapData.forEach(point => {
                if (point.latitud && point.longitud) {
                    const performance = parseFloat(point.promedio_cas_periodo) || parseFloat(point.promedio) || 0;
                    const color = performance >= 90 ? '#34C759' : 
                                 performance >= 80 ? '#007AFF' :
                                 performance >= 70 ? '#FFCC00' : '#FF3B30';
                    
                    const marker = L.circleMarker([point.latitud, point.longitud], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    const tooltipContent = `
                        <div style="font-family: -apple-system, sans-serif; text-align: center;">
                            <strong>${point.nombre}</strong><br>
                            <span style="color: #666;">${point.estado}</span><br>
                            <span style="font-weight: 600; color: ${color};">
                                ${performance.toFixed(1)}%
                            </span>
                        </div>
                    `;
                    marker.bindTooltip(tooltipContent);
                }
            });
            
            updateSucursalesList();
            
            if (currentTab === 'mapa') {
                setTimeout(() => {
                    initMapCollapsible();
                }, 100);
            }
        }

        function updateSucursalesList() {
            const container = document.getElementById('sucursales-list');
            if (mapData.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ios-gray);">No hay datos del mapa disponibles</div>';
                return;
            }
            
            const sortedData = mapData.slice().sort((a, b) => {
                const perfA = parseFloat(a.promedio_cas_periodo) || parseFloat(a.promedio) || 0;
                const perfB = parseFloat(b.promedio_cas_periodo) || parseFloat(b.promedio) || 0;
                return perfB - perfA;
            });
            
            const html = sortedData.map((point, index) => {
                const performance = parseFloat(point.promedio_cas_periodo) || parseFloat(point.promedio) || 0;
                const rankClass = performance >= 90 ? 'rank-good' : 
                                 performance >= 70 ? 'rank-warning' : 'rank-critical';
                
                return `
                    <div class="list-item ${rankClass}" onclick="zoomToLocation(${point.latitud}, ${point.longitud})">
                        <div class="rank">${index + 1}</div>
                        <div class="info">
                            <div class="name">${point.nombre}</div>
                            <div class="details">${point.estado} ¬∑ Grupo ${point.grupo || 'N/A'}</div>
                        </div>
                        <div class="performance ${performance >= 90 ? 'excellent' : performance >= 70 ? 'good' : 'critical'}">
                            ${performance.toFixed(1)}%
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function updateMapStats() {
            const subtitle = document.getElementById('map-subtitle');
            if (subtitle && mapData.length > 0) {
                const avgPerformance = mapData.reduce((sum, point) => {
                    return sum + (parseFloat(point.promedio_cas_periodo) || parseFloat(point.promedio) || 0);
                }, 0) / mapData.length;
                
                subtitle.textContent = `${mapData.length} sucursales ¬∑ ${avgPerformance.toFixed(1)}% promedio`;
            }
        }

        function zoomToLocation(lat, lng) {
            if (map) {
                map.flyTo([lat, lng], 12, {
                    animate: true,
                    duration: 1.5
                });
            }
        }

        function toggleMapFullscreen() {
            const mapContainer = document.querySelector('.map-container');
            const fullscreenBtn = document.getElementById('map-fullscreen-btn');
            
            if (mapContainer.classList.contains('fullscreen')) {
                mapContainer.classList.remove('fullscreen');
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                mapContainer.style.position = 'relative';
                mapContainer.style.top = 'auto';
                mapContainer.style.left = 'auto';
                mapContainer.style.width = 'auto';
                mapContainer.style.height = '300px';
                mapContainer.style.zIndex = 'auto';
            } else {
                mapContainer.classList.add('fullscreen');
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                mapContainer.style.position = 'fixed';
                mapContainer.style.top = '0';
                mapContainer.style.left = '0';
                mapContainer.style.width = '100vw';
                mapContainer.style.height = '100vh';
                mapContainer.style.zIndex = '9999';
                mapContainer.style.margin = '0';
            }
            
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 300);
        }

        function initMapCollapsible() {
            const dragHandle = document.getElementById('map-drag-handle');
            const mapContainer = document.querySelector('.map-container');
            const mapListContainer = document.getElementById('map-list-container');
            
            if (!dragHandle || !mapContainer || !mapListContainer) return;
            
            if (dragHandle.dataset.initialized === 'true') return;
            dragHandle.dataset.initialized = 'true';
            
            dragHandle.addEventListener('click', () => {
                if (mapExpanded) {
                    collapseMap();
                } else {
                    expandMap();
                }
            });
            
            function expandMap() {
                mapExpanded = true;
                mapContainer.classList.add('collapsed');
                mapListContainer.classList.add('expanded');
                
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
            }
            
            function collapseMap() {
                mapExpanded = false;
                mapContainer.classList.remove('collapsed');
                mapListContainer.classList.remove('expanded');
                
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
            }
        }

        // ==================================================================================
        // FUNCIONES DE HIST√ìRICO (HEATMAP)
        // ==================================================================================
        
        async function loadHeatmapData() {
            try {
                console.log('üî• Cargando datos del heatmap...');
                
                let endpoint = '/api/heatmap-periods/all';
                if (currentFilters.estado && currentFilters.estado !== 'all') {
                    endpoint += `?estado=${encodeURIComponent(currentFilters.estado)}`;
                }
                
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`Heatmap API error: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    heatmapPeriodsData = data.data;
                    console.log('‚úÖ Heatmap data loaded:', heatmapPeriodsData.groups.length, 'groups');
                    renderHeatmap();
                    setupHeatmapFilters();
                } else {
                    console.warn('‚ö†Ô∏è Heatmap API returned no data, using mock');
                    generateMockHeatmapData();
                }
            } catch (error) {
                console.error('‚ùå Error loading heatmap data:', error);
                generateMockHeatmapData();
            }
        }

        function generateMockHeatmapData() {
            console.log('üîß Generando datos mock para heatmap...');
            
            const periods = ['T1-2025', 'T2-2025', 'T3-2025', 'T4-2025'];
            const groups = allGroups.slice(0, 15).map(group => ({
                grupo: group.name,
                promedio_general: group.performance,
                periodos: {}
            }));
            
            groups.forEach(group => {
                periods.forEach(period => {
                    const basePerformance = group.promedio_general;
                    const variation = (Math.random() - 0.5) * 10;
                    const performance = Math.max(60, Math.min(100, basePerformance + variation));
                    
                    group.periodos[period] = {
                        promedio: performance,
                        evaluaciones: Math.floor(Math.random() * 50) + 10
                    };
                });
            });
            
            heatmapPeriodsData = {
                periods: periods,
                groups: groups
            };
            
            console.log('‚úÖ Mock heatmap data generated');
            renderHeatmap();
            setupHeatmapFilters();
        }

        function renderHeatmap(filter = 'all') {
            if (!heatmapPeriodsData || !heatmapPeriodsData.groups) {
                showHeatmapError('No hay datos disponibles');
                return;
            }
            
            const heatmapBody = document.getElementById('heatmapBody');
            const heatmapHeader = document.getElementById('heatmapHeader');
            if (!heatmapBody || !heatmapHeader) return;
            
            console.log('üî• Renderizando heatmap con filtro:', filter);
            
            let filteredGroups = heatmapPeriodsData.groups.slice();
            
            switch(filter) {
                case 'critical':
                    filteredGroups = filteredGroups.filter(group => group.promedio_general < 80);
                    break;
                case 'improving':
                    filteredGroups = filteredGroups.filter(group => {
                        const periods = heatmapPeriodsData.periods;
                        if (periods.length < 2) return false;
                        const periodValues = periods.map(p => group.periodos[p]?.promedio || 0).filter(v => v > 0);
                        if (periodValues.length < 2) return false;
                        return periodValues[periodValues.length - 1] > periodValues[periodValues.length - 2];
                    });
                    break;
                case 'declining':
                    filteredGroups = filteredGroups.filter(group => {
                        const periods = heatmapPeriodsData.periods;
                        if (periods.length < 2) return false;
                        const periodValues = periods.map(p => group.periodos[p]?.promedio || 0).filter(v => v > 0);
                        if (periodValues.length < 2) return false;
                        return periodValues[periodValues.length - 1] < periodValues[periodValues.length - 2];
                    });
                    break;
            }
            
            const periods = heatmapPeriodsData.periods || [];
            
            // Update header
            heatmapHeader.innerHTML = '<th>Grupo Operativo</th>';
            periods.forEach(period => {
                const th = document.createElement('th');
                th.textContent = period;
                heatmapHeader.appendChild(th);
            });
            const avgTh = document.createElement('th');
            avgTh.textContent = 'Prom';
            heatmapHeader.appendChild(avgTh);
            
            heatmapBody.innerHTML = '';
            
            // Calculate EPL CAS averages
            const eplAverages = {};
            let eplOverallSum = 0;
            let eplOverallCount = 0;
            
            periods.forEach(periodo => {
                let periodSum = 0;
                let periodCount = 0;
                
                heatmapPeriodsData.groups.forEach(group => {
                    const periodData = group.periodos[periodo];
                    if (periodData && periodData.promedio > 0) {
                        periodSum += periodData.promedio;
                        periodCount++;
                    }
                });
                
                eplAverages[periodo] = periodCount > 0 ? periodSum / periodCount : null;
                if (eplAverages[periodo] !== null) {
                    eplOverallSum += eplAverages[periodo];
                    eplOverallCount++;
                }
            });
            
            const eplOverallAverage = eplOverallCount > 0 ? eplOverallSum / eplOverallCount : 0;
            
            // Add EPL CAS row
            const eplRow = document.createElement('tr');
            eplRow.className = 'epl-cas-row';
            
            const eplLabelCell = document.createElement('td');
            eplLabelCell.innerHTML = `<div style="color: white; font-weight: bold;">PROMEDIO EPL CAS</div>`;
            eplRow.appendChild(eplLabelCell);
            
            let lastValidEpl = null;
            const showDifferences = document.getElementById('showDifferences')?.checked ?? true;
            
            periods.forEach((periodo, index) => {
                const cell = document.createElement('td');
                cell.style.textAlign = 'center';
                
                if (eplAverages[periodo] !== null) {
                    const promedio = eplAverages[periodo];
                    let cellContent = `<div style="color: white; font-weight: bold;">${promedio.toFixed(1)}%</div>`;
                    
                    if (showDifferences && lastValidEpl !== null) {
                        const diff = promedio - lastValidEpl;
                        const diffSign = diff > 0 ? '+' : '';
                        const trendArrow = diff > 0 ? '‚Üó' : diff < 0 ? '‚Üò' : '‚Üí';
                        cellContent += `<div style="font-size: 0.7rem; color: rgba(255,255,255,0.9);">${trendArrow} ${diffSign}${diff.toFixed(1)}%</div>`;
                    }
                    
                    cell.innerHTML = cellContent;
                    cell.style.backgroundColor = 'var(--ios-blue)';
                    cell.style.color = 'white';
                    lastValidEpl = promedio;
                } else {
                    cell.textContent = '-';
                    cell.style.backgroundColor = 'var(--ios-blue)';
                    cell.style.color = 'white';
                }
                
                eplRow.appendChild(cell);
            });
            
            // EPL average cell
            const eplAvgCell = document.createElement('td');
            eplAvgCell.style.textAlign = 'center';
            eplAvgCell.style.backgroundColor = 'var(--ios-blue)';
            eplAvgCell.style.color = 'white';
            eplAvgCell.style.fontWeight = 'bold';
            eplAvgCell.textContent = `${eplOverallAverage.toFixed(1)}%`;
            eplRow.appendChild(eplAvgCell);
            
            heatmapBody.appendChild(eplRow);
            
            // Sort and add group rows
            const sortedGroups = filteredGroups.sort((a, b) => b.promedio_general - a.promedio_general);
            
            sortedGroups.forEach(group => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = group.grupo;
                nameCell.style.fontWeight = '600';
                row.appendChild(nameCell);
                
                let lastValidValue = null;
                
                periods.forEach((periodo, index) => {
                    const cell = document.createElement('td');
                    cell.style.textAlign = 'center';
                    const periodData = group.periodos[periodo];
                    
                    if (periodData && periodData.promedio !== null && periodData.promedio > 0) {
                        const performance = periodData.promedio;
                        let cellContent = `<div style="font-weight: 600;">${performance.toFixed(1)}%</div>`;
                        
                        if (showDifferences && lastValidValue !== null) {
                            const diff = performance - lastValidValue;
                            const diffClass = diff > 0 ? 'diff-positive' : 'diff-negative';
                            const diffSign = diff > 0 ? '+' : '';
                            const trendArrow = diff > 0 ? '‚Üó' : diff < 0 ? '‚Üò' : '‚Üí';
                            cellContent += `<div class="${diffClass}" style="font-size: 0.7rem;">${trendArrow} ${diffSign}${diff.toFixed(1)}%</div>`;
                        } else if (!showDifferences) {
                            cellContent += `<div style="font-size: 0.7rem; opacity: 0.8;">${periodData.evaluaciones} eval.</div>`;
                        }
                        
                        cell.innerHTML = cellContent;
                        cell.className = getHeatClass(performance);
                        lastValidValue = performance;
                    } else {
                        cell.textContent = '-';
                        cell.style.color = '#666';
                    }
                    
                    row.appendChild(cell);
                });
                
                // Average cell
                const avgCell = document.createElement('td');
                avgCell.style.textAlign = 'center';
                avgCell.className = getHeatClass(group.promedio_general);
                avgCell.style.fontWeight = '600';
                avgCell.textContent = `${group.promedio_general.toFixed(1)}%`;
                row.appendChild(avgCell);
                
                heatmapBody.appendChild(row);
            });
        }

        function getHeatClass(performance) {
            if (performance >= 95) return 'heat-excelente';
            if (performance >= 91) return 'heat-muy-bueno';
            if (performance >= 87) return 'heat-bueno';
            if (performance >= 82) return 'heat-regular';
            return 'heat-critico';
        }

        function setupHeatmapFilters() {
            document.querySelectorAll('.heatmap-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.heatmap-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const filter = btn.dataset.filter;
                    heatmapCurrentFilter = filter;
                    renderHeatmap(filter);
                });
            });
            
            const showDifferencesToggle = document.getElementById('showDifferences');
            if (showDifferencesToggle) {
                showDifferencesToggle.addEventListener('change', () => {
                    renderHeatmap(heatmapCurrentFilter || 'all');
                });
            }
        }

        function showHeatmapError(message) {
            const heatmapBody = document.getElementById('heatmapBody');
            if (heatmapBody) {
                heatmapBody.innerHTML = `
                    <tr>
                        <td colspan="100%" style="text-align: center; padding: 40px; color: var(--ios-red);">
                            <i class="fas fa-exclamation-triangle"></i> ${message}
                        </td>
                    </tr>
                `;
            }
        }

        // ==================================================================================
        // FUNCIONES DE ALERTAS
        // ==================================================================================
        
        async function loadAlertas() {
            try {
                console.log('üö® Cargando alertas...');
                
                const alertas = [];
                
                // Alertas basadas en datos reales
                const criticalGroups = allGroups.filter(g => g.performance < 70);
                const decliningGroups = allGroups.filter(g => g.trend < -5);
                const excellentGroups = allGroups.filter(g => g.performance >= 95);
                
                criticalGroups.forEach(group => {
                    alertas.push({
                        type: 'critical',
                        title: `üö® Grupo Cr√≠tico: ${group.name}`,
                        description: `Performance de ${group.performance.toFixed(1)}% requiere atenci√≥n inmediata`,
                        time: 'Hace 2 horas'
                    });
                });
                
                decliningGroups.forEach(group => {
                    alertas.push({
                        type: 'warning',
                        title: `‚ö†Ô∏è Tendencia Negativa: ${group.name}`,
                        description: `Declive de ${Math.abs(group.trend).toFixed(1)}% vs promedio general`,
                        time: 'Hace 4 horas'
                    });
                });
                
                excellentGroups.forEach(group => {
                    alertas.push({
                        type: 'info',
                        title: `‚ú® Excelente Performance: ${group.name}`,
                        description: `Performance sobresaliente de ${group.performance.toFixed(1)}%`,
                        time: 'Hace 1 hora'
                    });
                });
                
                // Alerta del sistema
                alertas.push({
                    type: 'info',
                    title: 'üìä Actualizaci√≥n del Sistema',
                    description: `Datos actualizados correctamente. ${allGroups.length} grupos operativos y ${mapData.length} sucursales con coordenadas validadas`,
                    time: 'Hace 30 minutos'
                });
                
                // Alerta de cortes de per√≠odo
                alertas.push({
                    type: 'info',
                    title: 'üìÖ Per√≠odos T4 Local y S2 For√°neas',
                    description: 'T4 Local inici√≥ el 10 de octubre. S2 For√°neas cerr√≥ el 7 de octubre.',
                    time: 'Actualizado hoy'
                });
                
                const alertasHTML = alertas.map(alerta => `
                    <div class="alert-card ${alerta.type}">
                        <div class="alert-title">${alerta.title}</div>
                        <div class="alert-description">${alerta.description}</div>
                        <div class="alert-time">${alerta.time}</div>
                    </div>
                `).join('');
                
                updateContainer('alertas-container', alertasHTML);
                console.log('‚úÖ Alertas cargadas:', alertas.length);
            } catch (error) {
                console.error('‚ùå Error loading alertas:', error);
                updateContainer('alertas-container', '<div class="alert-card critical"><div class="alert-title">Error al cargar alertas</div></div>');
            }
        }

        // ==================================================================================
        // FUNCIONES DE CHARTS
        // ==================================================================================
        
        function initCharts() {
            // Performance distribution chart
            const ctx1 = document.getElementById('performanceChart');
            if (ctx1 && !performanceChart) {
                const excellent = allGroups.filter(g => g.performance >= 90).length;
                const good = allGroups.filter(g => g.performance >= 80 && g.performance < 90).length;
                const regular = allGroups.filter(g => g.performance >= 70 && g.performance < 80).length;
                const critical = allGroups.filter(g => g.performance < 70).length;
                
                performanceChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Excelentes ‚â•90%', 'Buenos 80-89%', 'Regulares 70-79%', 'Cr√≠ticos <70%'],
                        datasets: [{
                            data: [excellent, good, regular, critical],
                            backgroundColor: ['#34C759', '#007AFF', '#FFCC00', '#FF3B30'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateCharts(filteredGroups) {
            const excellent = filteredGroups.filter(g => g.performance >= 90).length;
            const good = filteredGroups.filter(g => g.performance >= 80 && g.performance < 90).length;
            const regular = filteredGroups.filter(g => g.performance >= 70 && g.performance < 80).length;
            const critical = filteredGroups.filter(g => g.performance < 70).length;
            
            if (performanceChart) {
                performanceChart.data.datasets[0].data = [excellent, good, regular, critical];
                performanceChart.update();
            }
            
            // Destroy existing critical chart
            if (criticalChart) {
                criticalChart.destroy();
                criticalChart = null;
            }
            
            // Create critical chart for critical view
            if (currentView === 'criticos' && !criticalChart) {
                const ctx2 = document.getElementById('criticalChart');
                if (ctx2) {
                    const criticalData = filteredGroups.filter(g => g.performance < 80);
                    if (criticalData.length > 0) {
                        criticalChart = new Chart(ctx2, {
                            type: 'bar',
                            data: {
                                labels: criticalData.map(g => g.name.length > 15 ? g.name.substring(0, 15) + '...' : g.name),
                                datasets: [{
                                    data: criticalData.map(g => g.performance),
                                    backgroundColor: criticalData.map(g => 
                                        g.performance >= 70 ? '#FFCC00' : '#FF3B30'
                                    ),
                                    borderWidth: 0,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }
        }

        function updateHorizontalCharts(filteredGroups) {
            if (horizontalChart) {
                horizontalChart.destroy();
                horizontalChart = null;
            }
            
            const ctx = document.getElementById('horizontalChart');
            if (ctx && currentViewMode === 'chart') {
                const topGroups = filteredGroups.slice(0, 10);
                
                horizontalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topGroups.map(g => g.name.length > 20 ? g.name.substring(0, 20) + '...' : g.name),
                        datasets: [{
                            label: 'Performance %',
                            data: topGroups.map(g => g.performance),
                            backgroundColor: topGroups.map(g => 
                                g.performance >= 90 ? '#34C759' : 
                                g.performance >= 80 ? '#007AFF' : 
                                g.performance >= 70 ? '#FFCC00' : '#FF3B30'
                            ),
                            borderWidth: 0,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateGruposChart(filteredGroups) {
            if (gruposChart) {
                gruposChart.destroy();
                gruposChart = null;
            }
            
            const ctx = document.getElementById('gruposChart');
            if (ctx) {
                const topGroups = filteredGroups.slice(0, 10);
                
                gruposChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topGroups.map(g => g.name.length > 15 ? g.name.substring(0, 15) + '...' : g.name),
                        datasets: [{
                            label: 'Performance %',
                            data: topGroups.map(g => g.performance),
                            backgroundColor: '#007AFF',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ==================================================================================
        // FUNCIONES DE NAVEGACI√ìN
        // ==================================================================================
        
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab bar
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Hide all views
            document.querySelectorAll('.tab-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(`${tab}-view`).classList.add('active');
            
            // Update nav title
            const titles = {
                dashboard: 'Dashboard CAS',
                mapa: 'Mapa',
                tendencias: 'Hist√≥rico',
                alertas: 'Alertas'
            };
            document.getElementById('nav-title').textContent = titles[tab];
            
            // Load specific data for each tab
            if (tab === 'mapa') {
                loadMapData();
                setTimeout(() => {
                    initMapCollapsible();
                }, 200);
            } else if (tab === 'tendencias') {
                loadHeatmapData();
            } else if (tab === 'alertas') {
                loadAlertas();
            }
        }

        function switchView(view) {
            currentView = view;
            
            // Update segments
            document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all views
            document.getElementById('general-view').style.display = 'none';
            document.getElementById('grupos-view').style.display = 'none';
            document.getElementById('criticos-view').style.display = 'none';
            
            // Show selected view
            document.getElementById(`${view}-view`).style.display = 'block';
            
            if (view === 'grupos') {
                updateAllGrupos();
            } else if (view === 'criticos') {
                updateCharts(allGroups);
            }
        }

        function switchViewMode(mode) {
            currentViewMode = mode;
            
            // Update toggle buttons
            document.querySelectorAll('.view-mode-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'list') {
                document.getElementById('general-view').style.display = 'block';
                document.getElementById('charts-view').style.display = 'none';
                
                // In grupos view: show list
                const gruposList = document.querySelector('#grupos-view .list-view');
                const gruposChart = document.querySelector('#grupos-view .chart-view');
                if (gruposList) gruposList.style.display = 'block';
                if (gruposChart) gruposChart.style.display = 'none';
            } else {
                document.getElementById('general-view').style.display = 'none';
                document.getElementById('charts-view').style.display = 'block';
                initCharts();
                updateHorizontalCharts(filterGroups());
                
                // In grupos view: show chart
                const gruposList = document.querySelector('#grupos-view .list-view');
                const gruposChart = document.querySelector('#grupos-view .chart-view');
                if (gruposList) gruposList.style.display = 'none';
                if (gruposChart) {
                    gruposChart.style.display = 'block';
                    updateGruposChart(filterGroups());
                }
            }
        }

        // ==================================================================================
        // FUNCIONES DE UTILIDADES
        // ==================================================================================
        
        function buildQueryString() {
            const params = new URLSearchParams();
            
            if (currentFilters.periodo && currentFilters.periodo !== 'all') {
                params.append('periodoCas', currentFilters.periodo);
            }
            
            if (currentFilters.grupo) {
                params.append('grupo', currentFilters.grupo);
            }
            
            if (currentFilters.estado && currentFilters.estado !== 'all') {
                params.append('estado', currentFilters.estado);
            }
            
            const queryString = params.toString();
            return queryString ? `?${queryString}` : '';
        }

        function updateKPIs() {
            document.getElementById('performance-general').textContent = 
                kpiData.promedio_general ? `${parseFloat(kpiData.promedio_general).toFixed(1)}%` : '--%';
            document.getElementById('total-supervisiones').textContent = 
                kpiData.total_evaluaciones || kpiData.total_supervisiones || '--';
            document.getElementById('total-grupos').textContent = 
                kpiData.grupos_activos || kpiData.total_grupos || allGroups.length || '--';
            document.getElementById('grupos-criticos').textContent = 
                kpiData.sucursales_evaluadas || kpiData.unique_locations || mapData.length || '--';
        }

        function populateGroupSelect() {
            const select = document.getElementById('grupo-select');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Todos los grupos</option>';
            
            const groupsToUse = allGroupsComplete.length > 0 ? allGroupsComplete : allGroups;
            
            groupsToUse.forEach(group => {
                const option = document.createElement('option');
                option.value = group.name;
                option.textContent = `${group.name} (${group.performance.toFixed(1)}%)`;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateUI() {
            let filteredGroups = filterGroups();
            
            // Update top performers
            const topPerformers = filteredGroups.slice(0, 5);
            updateContainer('top-performers', topPerformers.map(group => createListItem(group)).join(''));
            
            // Update critical performers
            const criticalPerformers = filteredGroups.filter(g => g.performance < 80);
            updateContainer('critical-performers', 
                criticalPerformers.length > 0 
                    ? criticalPerformers.map(group => createListItem(group)).join('')
                    : '<div style="padding: 20px; text-align: center; color: var(--ios-gray);">üéâ No hay grupos cr√≠ticos</div>'
            );
            
            // Update charts
            updateCharts(filteredGroups);
            
            if (currentViewMode === 'chart') {
                updateHorizontalCharts(filteredGroups);
            }
        }

        function updateAllGrupos() {
            const filteredGroups = filterGroups();
            const html = filteredGroups.map(group => createListItem(group, true)).join('');
            updateContainer('all-grupos', html);
            
            if (currentViewMode === 'chart') {
                setTimeout(() => updateGruposChart(filteredGroups), 100);
            }
        }

        function filterGroups() {
            let filtered = allGroups.slice();
            
            if (currentFilters.performance !== 'all') {
                filtered = filtered.filter(g => {
                    switch(currentFilters.performance) {
                        case 'excellent': return g.performance >= 90;
                        case 'good': return g.performance >= 80 && g.performance < 90;
                        case 'regular': return g.performance >= 70 && g.performance < 80;
                        case 'critical': return g.performance < 70;
                        default: return true;
                    }
                });
            }
            
            return filtered;
        }

        function updateContainer(id, content) {
            const container = document.getElementById(id);
            if (container) {
                container.innerHTML = content;
            }
        }

        function createListItem(group, detailed = false) {
            const rankClass = group.rank <= 3 ? `rank-${group.rank}` : 
                             group.performance >= 90 ? 'rank-good' : 
                             group.performance >= 70 ? 'rank-warning' : 'rank-critical';
            
            const trendIndicator = detailed ? `
                <br><span class="trend ${group.trend >= 0 ? 'diff-positive' : 'diff-negative'}">
                    ${group.trend >= 0 ? '‚Üó' : '‚Üò'} ${group.trend >= 0 ? '+' : ''}${group.trend.toFixed(1)}% vs promedio
                </span>
            ` : '';
            
            return `
                <div class="list-item ${rankClass}" onclick="showGroupDetail('${group.name}')">
                    <div class="rank">${group.rank}</div>
                    <div class="info">
                        <div class="name">${group.name}</div>
                        <div class="details">
                            ${group.estado} ¬∑ ${group.supervisiones} supervisiones${trendIndicator}
                        </div>
                    </div>
                    <div class="performance ${group.performance >= 90 ? 'excellent' : group.performance >= 70 ? 'good' : 'critical'}">
                        ${group.performance.toFixed(1)}%
                    </div>
                </div>
            `;
        }

        function showGroupDetail(groupName) {
            const group = allGroups.find(g => g.name === groupName);
            if (group) {
                alert(`Grupo: ${group.name}\nPerformance: ${group.performance.toFixed(1)}%\nSupervisiones: ${group.supervisiones}\nEstado: ${group.estado}\nRanking: #${group.rank}`);
            }
        }

        function initEventListeners() {
            // Filter pills - Event delegation
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-pill')) {
                    const container = e.target.closest('.filter-pills');
                    if (container) {
                        const filterType = container.id.replace('-filters', '');
                        const value = e.target.dataset.value;
                        
                        // Update active state
                        container.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        // Update filter
                        currentFilters[filterType] = value;
                        
                        // Reset grupo if estado changes
                        if (filterType === 'estado' && currentFilters.grupo) {
                            currentFilters.grupo = '';
                            const grupoSelect = document.getElementById('grupo-select');
                            if (grupoSelect) grupoSelect.value = '';
                        }
                        
                        // Reload data
                        loadData();
                        
                        if (currentTab === 'mapa') {
                            loadMapData();
                        }
                    }
                }
            });
            
            // Grupo select
            const grupoSelect = document.getElementById('grupo-select');
            if (grupoSelect) {
                grupoSelect.addEventListener('change', function(e) {
                    currentFilters.grupo = e.target.value;
                    loadData();
                    if (currentTab === 'mapa') {
                        loadMapData();
                    }
                });
            }
        }

        // Control functions
        function showLoading() {
            // Add loading states to containers
        }

        function hideLoading() {
            // Remove loading states
        }

        function showError(message) {
            console.error('Error:', message);
            alert(message);
        }

        function refreshData() {
            console.log('üîÑ Refrescando datos...');
            loadData();
            if (currentTab === 'mapa') loadMapData();
            if (currentTab === 'tendencias') loadHeatmapData();
            if (currentTab === 'alertas') loadAlertas();
        }

        function resetFilters() {
            currentFilters = {
                periodo: 'all',
                performance: 'all',
                estado: 'all',
                grupo: ''
            };
            
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.value === 'all') {
                    pill.classList.add('active');
                }
            });
            
            const grupoSelect = document.getElementById('grupo-select');
            if (grupoSelect) grupoSelect.value = '';
            
            loadData();
            if (currentTab === 'mapa') loadMapData();
        }

        // ==================================================================================
        // LOG DE INICIALIZACI√ìN
        // ==================================================================================
        
        console.log('üì± Dashboard iOS Completo RESTAURADO');
        console.log('‚úÖ Funcionalidad completa con estructura nueva');
        console.log('üó∫Ô∏è Coordenadas validadas desde CSV');
        console.log('üìÖ Fechas de corte T4 Local y S2 For√°neas implementadas');
        console.log('üéØ Todas las funcionalidades originales preservadas');
    </script>
</body>
</html>