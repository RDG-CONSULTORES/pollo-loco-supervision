// =====================================================
// INTEGRACI√ìN WEB APP CON TELEGRAM BOT ANA
// Permite a Ana mostrar bot√≥n del dashboard y procesar datos
// =====================================================

const express = require('express');
const { Pool } = require('pg');

class WebAppIntegration {
    constructor(bot, pool) {
        this.bot = bot;
        this.pool = pool;
        
        // URL base de la web app (configurar seg√∫n deployment)
        this.webAppUrl = process.env.WEBAPP_URL || 'https://pollo-loco-dashboard.render.com';
        
        console.log('üåê Web App Integration inicializada:', this.webAppUrl);
    }

    // =====================================================
    // COMANDOS DE ANA PARA MOSTRAR DASHBOARD
    // =====================================================

    // Comando principal para mostrar dashboard
    getWebAppKeyboard(filters = {}) {
        const queryParams = new URLSearchParams(filters).toString();
        const url = queryParams ? `${this.webAppUrl}?${queryParams}` : this.webAppUrl;
        
        return {
            reply_markup: {
                inline_keyboard: [
                    [
                        {
                            text: "üìä Ver Dashboard Interactivo",
                            web_app: { url }
                        }
                    ],
                    [
                        {
                            text: "üìç Ver Mapa de Sucursales",
                            web_app: { url: `${this.webAppUrl}?tab=mapa` }
                        }
                    ],
                    [
                        {
                            text: "üìà Ver An√°lisis de Performance",
                            web_app: { url: `${this.webAppUrl}?tab=grupos` }
                        }
                    ]
                ]
            }
        };
    }

    // Respuesta de Ana con dashboard contextual
    async sendDashboardResponse(chatId, message, context = {}) {
        const baseResponse = `ü§ñ **Ana - Dashboard Interactivo**\n\n${message}`;
        
        // Determinar filtros basados en contexto
        const filters = this.extractFilters(context);
        const keyboard = this.getWebAppKeyboard(filters);
        
        await this.bot.sendMessage(chatId, baseResponse, {
            parse_mode: 'Markdown',
            ...keyboard
        });
    }

    // Extraer filtros del contexto de conversaci√≥n
    extractFilters(context) {
        const filters = {};
        
        if (context.grupoOperativo) {
            filters.grupo = context.grupoOperativo;
        }
        
        if (context.trimestre) {
            filters.trimestre = context.trimestre;
        }
        
        return filters;
    }

    // =====================================================
    // RESPUESTAS INTELIGENTES CON DASHBOARD
    // =====================================================

    // Respuesta para an√°lisis de grupos
    async respondGroupAnalysis(chatId, grupo) {
        const message = `üìä **An√°lisis de ${grupo}**\n\nAqu√≠ tienes el dashboard interactivo filtrado espec√≠ficamente para ${grupo}. Puedes ver:\n\n‚Ä¢ üìç Ubicaci√≥n de todas las sucursales\n‚Ä¢ üìà Performance detallado por √°reas\n‚Ä¢ üéØ Comparaci√≥n con otros grupos\n‚Ä¢ üìÖ Tendencias trimestrales\n\n¬°Explora los datos con filtros din√°micos!`;
        
        await this.sendDashboardResponse(chatId, message, { grupoOperativo: grupo });
    }

    // Respuesta para an√°lisis de performance general
    async respondPerformanceAnalysis(chatId) {
        const message = `üìà **An√°lisis de Performance General**\n\n¬°Perfecto! He preparado el dashboard completo con todos los KPIs principales:\n\n‚Ä¢ üèÜ Rankings de grupos operativos\n‚Ä¢ üéØ √Åreas de oportunidad identificadas\n‚Ä¢ üìä M√©tricas de red completas\n‚Ä¢ üó∫Ô∏è Vista geogr√°fica de todas las ubicaciones\n\nUsa los filtros para hacer an√°lisis m√°s espec√≠ficos.`;
        
        await this.sendDashboardResponse(chatId, message);
    }

    // Respuesta para an√°lisis de sucursales espec√≠ficas
    async respondLocationAnalysis(chatId, filters = {}) {
        let message = `üè™ **An√°lisis de Sucursales**\n\n`;
        
        if (filters.estado) {
            message += `An√°lisis espec√≠fico para **${filters.estado}**.\n\n`;
        }
        
        message += `El dashboard te permite:\n\n‚Ä¢ üìç Ver ubicaciones exactas en el mapa\n‚Ä¢ üìä Comparar performance entre sucursales\n‚Ä¢ üéØ Identificar oportunidades por zona\n‚Ä¢ üìà Analizar tendencias geogr√°ficas`;
        
        await this.sendDashboardResponse(chatId, message, filters);
    }

    // =====================================================
    // PROCESAMIENTO DE DATOS FROM WEB APP
    // =====================================================

    // Manejar datos enviados desde la web app
    async handleWebAppData(data, chatId) {
        try {
            const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
            
            switch (parsedData.action) {
                case 'request_report':
                    await this.generateReport(chatId, parsedData);
                    break;
                    
                case 'share_filters':
                    await this.shareFilteredAnalysis(chatId, parsedData);
                    break;
                    
                case 'export_data':
                    await this.exportAnalysis(chatId, parsedData);
                    break;
                    
                default:
                    console.log('üì± Unknown web app action:', parsedData.action);
            }
            
        } catch (error) {
            console.error('‚ùå Error procesando datos de web app:', error);
            await this.bot.sendMessage(chatId, 'ü§ñ Hubo un error procesando tu solicitud del dashboard.');
        }
    }

    // Generar reporte basado en datos del dashboard
    async generateReport(chatId, data) {
        const { stats } = data;
        
        const report = `üìä **Reporte Generado desde Dashboard**\n\n` +
                      `üè™ **Sucursales analizadas:** ${stats.locations}\n` +
                      `üë• **Grupos operativos:** ${stats.groups}\n` +
                      `üìà **Performance promedio:** ${stats.performance}%\n\n` +
                      `‚ú® **Insight de Ana:** ${this.generateInsight(stats.performance)}\n\n` +
                      `üéØ ¬øTe gustar√≠a que profundice en alg√∫n grupo espec√≠fico o √°rea de oportunidad?`;
        
        await this.bot.sendMessage(chatId, report, { parse_mode: 'Markdown' });
    }

    // Compartir an√°lisis filtrado
    async shareFilteredAnalysis(chatId, data) {
        const { filters } = data;
        const activeFilters = Object.entries(filters).filter(([key, value]) => value);
        
        if (activeFilters.length === 0) {
            await this.bot.sendMessage(chatId, 'üìä Vista general de toda la red - ¬°an√°lisis completo disponible!');
            return;
        }
        
        const filterDescription = activeFilters.map(([key, value]) => {
            switch (key) {
                case 'grupo': return `üë• Grupo: ${value}`;
                case 'estado': return `üìç Estado: ${value}`;
                case 'trimestre': return `üìÖ Trimestre: Q${value} 2025`;
                default: return `${key}: ${value}`;
            }
        }).join('\n');
        
        const message = `üîç **An√°lisis Filtrado Compartido**\n\n${filterDescription}\n\n¬øTe gustar√≠a que haga un an√°lisis m√°s profundo de estos resultados espec√≠ficos?`;
        
        await this.bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
    }

    // Generar insight autom√°tico basado en performance
    generateInsight(performance) {
        if (performance >= 95) {
            return "¬°Excelente! La red est√° operando en niveles √≥ptimos. Considera replicar estas mejores pr√°cticas.";
        } else if (performance >= 90) {
            return "Muy buen rendimiento general. Hay oportunidades espec√≠ficas para llegar a la excelencia.";
        } else if (performance >= 85) {
            return "Performance s√≥lido con margen de mejora. Identifica las √°reas cr√≠ticas para optimizaci√≥n.";
        } else {
            return "Se requiere atenci√≥n inmediata. Concentra esfuerzos en las sucursales y √°reas de menor rendimiento.";
        }
    }

    // =====================================================
    // M√âTODOS PARA INTEGRAR CON ANA INTELLIGENT
    // =====================================================

    // Detectar si una pregunta deber√≠a mostrar dashboard
    shouldShowDashboard(question) {
        const dashboardTriggers = [
            'dashboard', 'mapa', 'gr√°fico', 'visual', 'interactivo',
            'ubicaci√≥n', 'coordenadas', 'geogr√°fico',
            'comparar', 'an√°lisis', 'tendencia', 'evoluci√≥n',
            'filtrar', 'explorar', 'investigar'
        ];
        
        return dashboardTriggers.some(trigger => 
            question.toLowerCase().includes(trigger)
        );
    }

    // Enriquecer respuesta de Ana con dashboard
    async enrichResponseWithDashboard(originalResponse, context, chatId) {
        // Si la respuesta ya incluye an√°lisis num√©rico, ofrecer dashboard
        if (this.hasNumericData(originalResponse) || this.shouldShowDashboard(context.originalQuestion)) {
            
            const enrichedResponse = originalResponse + 
                `\n\nüí° **¬°Tip de Ana!** Para una exploraci√≥n m√°s profunda e interactiva de estos datos, usa el dashboard:`;
            
            await this.sendDashboardResponse(chatId, enrichedResponse, context);
            return true;
        }
        
        return false;
    }

    // Detectar si la respuesta contiene datos num√©ricos
    hasNumericData(response) {
        const numericPatterns = [
            /\d+%/g,           // Porcentajes
            /\d+\.\d+/g,       // Decimales
            /\d+ sucursales?/gi, // Sucursales
            /\d+ grupos?/gi,    // Grupos
            /promedio/gi,      // Promedios
            /(top|mejor|peor)/gi // Rankings
        ];
        
        return numericPatterns.some(pattern => pattern.test(response));
    }
}

module.exports = WebAppIntegration;